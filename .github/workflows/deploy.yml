name: Deploy Smarter Store API

on:
  push:
    branches:
      - main
  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•´ ì¶”ê°€
  workflow_dispatch:

env:
  # Docker Hub ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì • (Secrets ì°¸ì¡°)
  DOCKER_IMAGE_PATH: ${{ secrets.DOCKER_USERNAME }}/smarter-store-api

jobs:
  build-and-push:
    # ë¹Œë“œëŠ” GitHub-hosted runner (AMD64)ì—ì„œ ìˆ˜í–‰
    runs-on: ubuntu-latest
    # Job Outputì€ ë³´ì•ˆ ê²½ê³ ë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì œê±°ë¨

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Commit Message
        id: commit
        run: |
          # ì´ì „ ì»¤ë°‹ í•´ì‹œ (Push ì´ë²¤íŠ¸)
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          
          # beforeê°€ ì—†ê±°ë‚˜ 000...ì¸ ê²½ìš° (ìµœì´ˆ í‘¸ì‹œ, ìˆ˜ë™ ì‹¤í–‰ ë“±)
          if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
             # ìµœê·¼ 5ê°œ ì»¤ë°‹ë§Œ í‘œì‹œ
             MSG=$(git log -5 --pretty=format:"â€¢ %s")
          else
             # ë³€ê²½ëœ ë²”ìœ„ì˜ ì»¤ë°‹ ëª©ë¡ í‘œì‹œ
             MSG=$(git log $BEFORE..$AFTER --pretty=format:"â€¢ %s")
          fi
          
          echo "message<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MSG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Notify Slack on Start
        env:
          COMMIT_MSG: ${{ steps.commit.outputs.message }}
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ì˜ ê°œí–‰ ë¬¸ì ë“±ì„ JSON ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          ESCAPED_MSG=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸš€ *ë°°í¬ ì‹œì‘*\",
              \"attachments\": [{
                \"color\": \"#439FE0\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Changes\", \"value\": \"$ESCAPED_MSG\", \"short\": false}
                ]
              }]
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL_DEPLOY }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        # í…ŒìŠ¤íŠ¸ëŠ” ì œì™¸í•˜ê³  JAR íŒŒì¼ë§Œ ë¹Œë“œ
        run: ./gradlew clean build -x test

      - name: Set Docker Tags
        id: set_tags
        run: |
          # Git SHA íƒœê·¸ì™€ latest íƒœê·¸ ì •ì˜
          echo "SHA_TAG=${{ env.DOCKER_IMAGE_PATH }}:${{ github.sha }}" >> "$GITHUB_OUTPUT"
          echo "LATEST_TAG=${{ env.DOCKER_IMAGE_PATH }}:latest" >> "$GITHUB_OUTPUT"

      # ğŸ“Œ ë³€ê²½ë¨: Multi-Arch ë¹Œë“œë¥¼ ìœ„í•œ ì„¤ì • ì‹œì‘
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image (Multi-Arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.set_tags.outputs.SHA_TAG }}
            ${{ steps.set_tags.outputs.LATEST_TAG }}
          # ğŸ“Œ ì¤‘ìš”: ëŒ€ìƒ í”Œë«í¼ì„ linux/arm64ë¡œ ì§€ì •í•˜ì—¬ Raspberry Pi/Orange Pi í™˜ê²½ì— ë§ì¶¤
          platforms: linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
      # ğŸ“Œ Multi-Arch ë¹Œë“œë¥¼ ìœ„í•œ ì„¤ì • ë

  deploy:
    # ğŸ“Œ ë°°í¬ ì„œë²„ì— ì„¤ì¹˜ëœ self-hosted runnerì—ì„œ ì‹¤í–‰
    runs-on: self-hosted
    needs: build-and-push
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Hub Login (on self-hosted runner)
        # ë°°í¬ ì„œë²„(self-hosted runner)ì—ì„œ Docker Hubì— ë¡œê·¸ì¸
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Deploy with Docker Compose
        env:
          DOCKER_IMAGE_PATH: ${{ env.DOCKER_IMAGE_PATH }}
          JWT_SECRET_PROD: ${{ secrets.JWT_SECRET_PROD }}
          SPRING_DATASOURCE_URL: ${{ secrets.PROD_DB_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.PROD_DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          PROD_DB_USERNAME: ${{ secrets.PROD_DB_USERNAME }}
          PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
          SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_URL_DEPLOY: ${{ secrets.SLACK_WEBHOOK_URL_DEPLOY }}
          ENCRYPTION_SECRET_PROD: ${{ secrets.ENCRYPTION_SECRET_PROD }}
        run: |
          # 1. ê´€ë¦¬ ê²½ë¡œë¡œ ì´ë™
          cd ${{ vars.DOCKER_COMPOSE_PATH }}
          
          # 2. ìµœì‹  ì´ë¯¸ì§€ pull ë° ticket-be ì¬ì‹œì‘
          docker compose pull ticket-be
          docker compose up -d ticket-be
          
          # 3. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f

      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text": "âœ… *ë°°í¬ ì™„ë£Œ*"}' \
            ${{ secrets.SLACK_WEBHOOK_URL_DEPLOY }}

      - name: Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âŒ *ë°°í¬ ì‹¤íŒ¨*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸>"
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL_DEPLOY }}