# 좌석 예매 시스템 - 테스트 워크플로우

> **목적**: 프론트엔드/백엔드 개발자 간 협업을 위한 예매 시스템 통합 테스트 가이드

---

## 1. 사전 조건

### 1.1 테스트 환경 설정

| 항목 | 설명 |
|------|------|
| Base URL | `http://localhost:8080` |
| Authorization | `Bearer {JWT_TOKEN}` (USER 권한 필요) |
| Content-Type | `application/json` |

### 1.2 필수 테스트 데이터

테스트 전 아래 데이터가 준비되어 있어야 합니다:

```
1. 공연장 (Venue) - ID: {venueId}
   └── 좌석 배치도 (seatingChart) 저장 완료
   └── 등급별 좌석수 (VenueSeatCapacity) 설정 완료

2. 공연 (Performance) - ID: {performanceId}
   └── 공연 회차 (PerformanceSchedule) - ID: {scheduleId}
       └── 티켓 옵션 (TicketOption) 설정 완료
           예: VIP - 150,000원, R - 120,000원, S - 90,000원

3. 테스트 사용자 계정 (USER 권한)
   └── 로그인 후 JWT 토큰 확보
```

---

## 2. 정상 흐름 (Happy Path) 테스트

### Step 1: 예매 시작 (5분 타이머 가동)

**Request**
```http
POST /api/bookings/start
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "scheduleId": 1
}
```

**Expected Response (200 OK)**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "bookingNumber": "20251222-ABCDEFGH",
  "expiresAt": "2025-12-22T15:35:00",
  "remainingSeconds": 300,
  "seats": [],
  "totalPrice": 0,
  "status": "PENDING"
}
```

**FE 체크포인트**
- [ ] `bookingId`를 로컬 상태에 저장
- [ ] `remainingSeconds`로 카운트다운 타이머 시작 (5:00)
- [ ] 이미 진행 중인 예매가 있으면 해당 예매 정보 반환됨

---

### Step 2: 좌석 선택 (점유)

**Request**
```http
POST /api/bookings/{bookingId}/seats
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "section": "A",
  "rowName": "5",
  "seatNumber": 10
}
```

**Expected Response (200 OK)**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "bookingNumber": "20251222-ABCDEFGH",
  "expiresAt": "2025-12-22T15:35:00",
  "remainingSeconds": 285,
  "seats": [
    {
      "id": 1,
      "section": "A",
      "rowName": "5",
      "seatNumber": 10,
      "grade": "VIP",
      "price": 150000
    }
  ],
  "totalPrice": 150000,
  "status": "PENDING"
}
```

**FE 체크포인트**
- [ ] 선택한 좌석 색상을 "내 좌석"으로 변경
- [ ] `totalPrice` 업데이트
- [ ] `seats` 배열로 선택된 좌석 목록 표시
- [ ] 좌석 추가 선택 시 동일 API 호출 (최대 4석)

---

### Step 3: 좌석 선택 취소

**Request**
```http
DELETE /api/bookings/{bookingId}/seats
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "section": "A",
  "rowName": "5",
  "seatNumber": 10
}
```

**Expected Response (200 OK)**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "bookingNumber": "20251222-ABCDEFGH",
  "expiresAt": "2025-12-22T15:35:00",
  "remainingSeconds": 270,
  "seats": [],
  "totalPrice": 0,
  "status": "PENDING"
}
```

**FE 체크포인트**
- [ ] 해제된 좌석을 "선택 가능" 상태로 변경
- [ ] `totalPrice` 및 `seats` 배열 업데이트

---

### Step 4: 남은 시간 조회 (새로고침 대응)

**Request**
```http
GET /api/bookings/{bookingId}/time
Authorization: Bearer {JWT_TOKEN}
```

**Expected Response (200 OK)**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "remainingSeconds": 180,
  "expired": false
}
```

**FE 체크포인트**
- [ ] 페이지 새로고침 시 이 API로 서버 시간 기준 타이머 동기화
- [ ] `expired: true`이면 만료 처리 (홈 이동)

---

### Step 5: 예매 확정 (결제 완료)

**Request**
```http
POST /api/bookings/{bookingId}/confirm
Authorization: Bearer {JWT_TOKEN}
```

**Expected Response (200 OK)**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "bookingNumber": "20251222-ABCDEFGH",
  "expiresAt": "2025-12-22T15:35:00",
  "remainingSeconds": 0,
  "seats": [
    {
      "id": 1,
      "section": "A",
      "rowName": "5",
      "seatNumber": 10,
      "grade": "VIP",
      "price": 150000
    }
  ],
  "totalPrice": 150000,
  "status": "CONFIRMED"
}
```

**FE 체크포인트**
- [ ] `status: "CONFIRMED"` 확인
- [ ] 예매 완료 페이지로 이동
- [ ] `bookingNumber`로 예매 확인 정보 표시

---

### Step 6: 예매 취소 (선택 사항)

**Request**
```http
DELETE /api/bookings/{bookingId}
Authorization: Bearer {JWT_TOKEN}
```

**Expected Response (200 OK)**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "bookingNumber": "20251222-ABCDEFGH",
  "expiresAt": "2025-12-22T15:35:00",
  "remainingSeconds": 0,
  "seats": [],
  "totalPrice": 0,
  "status": "CANCELLED"
}
```

**FE 체크포인트**
- [ ] `status: "CANCELLED"` 확인
- [ ] 좌석 선택 페이지 또는 홈으로 이동

---

## 3. 에러 케이스 테스트

### 3.1 이미 선택된 좌석 (409 Conflict)

**시나리오**: 다른 사용자가 이미 선택한 좌석을 클릭

**Response**
```json
{
  "status": 409,
  "code": "SEAT_ALREADY_OCCUPIED",
  "message": "이미 선택된 좌석입니다."
}
```

**FE 체크포인트**
- [ ] 알림 팝업: "이미 선택된 좌석입니다"
- [ ] 해당 좌석을 "선택 불가" 상태로 변경
- [ ] 좌석 상태 새로고침 권장

---

### 3.2 최대 좌석 수 초과 (400 Bad Request)

**시나리오**: 이미 4석 선택 후 추가 좌석 선택 시도

**Response**
```json
{
  "status": 400,
  "code": "SEAT_LIMIT_EXCEEDED",
  "message": "최대 선택 가능 좌석 수(4석)를 초과했습니다."
}
```

**FE 체크포인트**
- [ ] 4석 선택 시 추가 선택 버튼 비활성화 권장
- [ ] 알림: "최대 4석까지 선택 가능합니다"

---

### 3.3 예매 시간 만료 (410 Gone)

**시나리오**: 5분 경과 후 좌석 선택 또는 결제 시도

**Response**
```json
{
  "status": 410,
  "code": "BOOKING_EXPIRED",
  "message": "예매 시간이 만료되었습니다."
}
```

**FE 체크포인트**
- [ ] 알림 팝업: "예매 시간이 만료되었습니다"
- [ ] 홈 또는 공연 상세 페이지로 자동 이동
- [ ] 타이머 0:00 도달 시 자동 만료 처리

---

### 3.4 예매를 찾을 수 없음 (404 Not Found)

**시나리오**: 잘못된 bookingId로 API 호출

**Response**
```json
{
  "status": 404,
  "code": "BOOKING_NOT_FOUND",
  "message": "해당 예매를 찾을 수 없습니다."
}
```

**FE 체크포인트**
- [ ] 홈으로 이동
- [ ] 세션 상태 점검 권장

---

### 3.5 유효하지 않은 예매 상태 (400 Bad Request)

**시나리오**: 이미 확정/취소된 예매에 대해 작업 시도

**Response**
```json
{
  "status": 400,
  "code": "BOOKING_INVALID_STATUS",
  "message": "유효하지 않은 예매 상태입니다."
}
```

**FE 체크포인트**
- [ ] 예매 상태 재확인 후 적절한 페이지로 이동

---

## 4. 엣지 케이스 테스트

### 4.1 브라우저 종료 후 재진입

| 단계 | 행동 | 예상 결과 |
|------|------|----------|
| 1 | 예매 시작 → 좌석 2개 선택 | 정상 진행 |
| 2 | 브라우저 종료 (탭 닫기) | 서버 타이머 계속 진행 |
| 3 | 5분 이내 재진입 | `GET /time` → 남은 시간 확인 후 타이머 재개 |
| 4 | 5분 이후 재진입 | `GET /time` → `expired: true` → 홈 이동 |

---

### 4.2 페이지 새로고침

| 단계 | 행동 | 예상 결과 |
|------|------|----------|
| 1 | 예매 진행 중 F5 (새로고침) | 페이지 리로드 |
| 2 | localStorage에서 bookingId 복원 | bookingId 확보 |
| 3 | `GET /time` 호출 | 서버 기준 남은 시간 조회 |
| 4 | 타이머 동기화 | 서버 시간 기준 카운트다운 재개 |

---

### 4.3 동시 좌석 선택 경쟁

| 사용자 A | 사용자 B | 결과 |
|----------|----------|------|
| A-5-10 좌석 클릭 | A-5-10 좌석 클릭 (동시) | 선착순 1명만 성공 |
| 200 OK | 409 Conflict | B에게 에러 응답 |

---

### 4.4 결제 버튼 클릭 직전 타이머 만료

| 단계 | 행동 | 예상 결과 |
|------|------|----------|
| 1 | 타이머: 0:03 남음 | 결제 버튼 활성화 상태 |
| 2 | 결제 버튼 클릭 (0:01) | API 요청 전송 |
| 3 | 서버 도달 시 만료 | 410 Gone 응답 |
| 4 | FE 처리 | 만료 알림 → 홈 이동 |

---

## 5. 통합 테스트 체크리스트

### 5.1 FE 필수 구현 항목

- [ ] **타이머**: 서버 `remainingSeconds` 기반 카운트다운
- [ ] **새로고침 대응**: `GET /time` API로 타이머 동기화
- [ ] **좌석 상태 관리**: 선택 가능 / 내 좌석 / 타인 좌석 / 판매 완료
- [ ] **최대 좌석 제한**: 4석 초과 선택 방지 (UI 레벨)
- [ ] **에러 핸들링**: 409, 410, 400, 404 에러별 처리
- [ ] **bookingId 저장**: localStorage 또는 sessionStorage

### 5.2 BE 필수 확인 항목

- [ ] **5분 타이머**: Booking.expiresAt 정상 설정
- [ ] **동시성 제어**: SeatLock Unique 제약 동작
- [ ] **만료 스케줄러**: 1분마다 PENDING → EXPIRED 변경
- [ ] **데이터 이관**: confirm 시 SeatLock → ScheduleSeatStatus

---

## 6. API 테스트 시퀀스 (cURL)

### 전체 흐름 테스트

```bash
# 1. 예매 시작
BOOKING=$(curl -s -X POST http://localhost:8080/api/bookings/start \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"scheduleId": 1}')

BOOKING_ID=$(echo $BOOKING | jq -r '.bookingId')
echo "Booking ID: $BOOKING_ID"

# 2. 좌석 선택 (1번째)
curl -X POST http://localhost:8080/api/bookings/${BOOKING_ID}/seats \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"section": "A", "rowName": "5", "seatNumber": 10}'

# 3. 좌석 선택 (2번째)
curl -X POST http://localhost:8080/api/bookings/${BOOKING_ID}/seats \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"section": "A", "rowName": "5", "seatNumber": 11}'

# 4. 남은 시간 확인
curl -X GET http://localhost:8080/api/bookings/${BOOKING_ID}/time \
  -H "Authorization: Bearer ${TOKEN}"

# 5. 좌석 선택 취소
curl -X DELETE http://localhost:8080/api/bookings/${BOOKING_ID}/seats \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"section": "A", "rowName": "5", "seatNumber": 11}'

# 6. 예매 확정
curl -X POST http://localhost:8080/api/bookings/${BOOKING_ID}/confirm \
  -H "Authorization: Bearer ${TOKEN}"

# (또는) 예매 취소
# curl -X DELETE http://localhost:8080/api/bookings/${BOOKING_ID} \
#   -H "Authorization: Bearer ${TOKEN}"
```

---

## 7. 테스트 결과 기록 템플릿

| 테스트 케이스 | 담당자 | 결과 | 비고 |
|--------------|--------|------|------|
| 정상 흐름 전체 | | Pass / Fail | |
| 좌석 중복 선택 | | Pass / Fail | |
| 최대 좌석 초과 | | Pass / Fail | |
| 타이머 만료 | | Pass / Fail | |
| 새로고침 복원 | | Pass / Fail | |
| 동시 선택 경쟁 | | Pass / Fail | |
| 결제 직전 만료 | | Pass / Fail | |

---

*Last Updated: 2025-12-22*
