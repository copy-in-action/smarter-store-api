# 공연/좌석 등록 플로우 가이드

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2025-12-10 | BE | 초안 작성 |
| 1.1 | 2025-12-17 | BE | Company API 필드명 수정, 좌석 관련 단계(2, 6단계) 설계 중 표시 추가, 데이터 관계도 수정 |

---

## 개요

이 문서는 관리자가 공연을 등록하고 예매를 오픈하기까지의 전체 흐름을 설명합니다.
프론트엔드 개발자와 협의하여 최적의 UI/UX를 설계하기 위한 참고 자료입니다.

---

## 전체 등록 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│  1. 공연장(Venue) 등록                                               │
│     - 공연장 이름, 주소, 대표번호                                     │
│     - 좌석배치도 이미지 URL (선택)                                    │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1-2. 등급별 허용좌석수 (VenueSeatCapacity) 등록                     │
│     - 공연장의 등급별 최대 수용 좌석 수 등록                           │
│     ※ 공연장마다 1회만 등록하면 됨 (재사용)                            │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. 좌석(Seat) 등록 ⚠️ (설계 중)                                     │
│     - 공연장에 속한 좌석 마스터 데이터 (구역, 열, 번호, 등급, 좌표)    │
│     ※ 공연장마다 1회만 등록하면 됨 (재사용)                            │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. 기획사(Company) 등록                                             │
│     - 기획사명, 대표자명, 사업자번호 등 기본 정보                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. 공연(Performance) 등록                                           │
│     - 공연 정보 (제목, 설명, 카테고리, 출연진, 기획사 등 상세 정보)   │
│     - 공연장 선택 (venueId)                                          │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. 공연 회차(Schedule) 등록                                         │
│     - 공연 일시, 판매 시작 일시                                       │
│     - 회차별 티켓 옵션 (좌석등급별 가격) 등록                           │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. 회차별 좌석(ScheduleSeat) 초기화 ⚠️ (설계 중)                     │
│     - 공연장 좌석을 해당 회차에 복사                                   │
│     - 좌석등급 ↔ 티켓옵션(가격) 매핑                                   │
│     - 모든 좌석 상태: AVAILABLE                                       │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  7. 공연 노출 (visible = true)                                       │
│     - 사용자에게 공연 공개                                            │
│     - 예매 시작                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 단계별 상세 설명

### 1단계: 공연장 등록

공연이 진행될 장소를 등록합니다.

```
POST /api/admin/venues
{
  "name": "올림픽공원 올림픽홀",
  "address": "서울시 송파구 올림픽로 424",
  "phoneNumber": "02-1234-5678", // 새로 추가된 필드
  "seatingChartUrl": null  // 좌석 등록 후 업데이트 가능
}
```

**등급별 허용좌석수 (VenueSeatCapacity) 등록**

등록된 공연장에 대해 등급별 좌석 수를 설정합니다. 이는 공연장의 물리적인 좌석 구성을 정의합니다.

#### 단일 등록
```
POST /api/admin/venues/{venueId}/seat-capacities
{
  "seatGrade": "VIP",     // 등급: VIP, R, S, A, B
  "capacity": 100         // 해당 등급의 총 좌석 수
}
```

#### 일괄 등록
```
POST /api/admin/venues/{venueId}/seat-capacities/bulk
{
  "seatCapacities": [
    { "seatGrade": "VIP", "capacity": 100 },
    { "seatGrade": "R", "capacity": 200 },
    { "seatGrade": "S", "capacity": 300 }
  ]
}
```

---

### 2단계: 좌석 등록 ⚠️ (설계 중)

> **Note:** 이 단계는 FE 피드백 기반으로 좌석 시스템 재설계가 진행 중입니다. API 스펙이 변경될 수 있습니다.

공연장에 속한 개별 좌석의 마스터 데이터를 등록합니다. 이는 공연장의 물리적인 좌석 배치 정보를 정의하며, 실제 예매 가능한 좌석의 위치 정보를 담습니다.

#### 단일 등록
```
POST /api/admin/venues/{venueId}/seats
{
  "section": "1층",       // 구역명 (자유 형식)
  "row": "A",             // 열 (자유 형식: A, B, 1, 2, VIP1 등)
  "number": 1,            // 좌석 번호 (1 이상 정수)
  "seatGrade": "VIP",     // 등급: VIP, R, S, A, B (VenueSeatCapacity의 등급과 일치해야 함)
  "positionX": 100,       // 좌석배치도 X좌표
  "positionY": 50         // 좌석배치도 Y좌표
}
```

#### 일괄 등록
```
POST /api/admin/venues/{venueId}/seats/bulk
{
  "seats": [
    { "section": "1층", "row": "A", "number": 1, "seatGrade": "VIP", "positionX": 100, "positionY": 50 },
    { "section": "1층", "row": "A", "number": 2, "seatGrade": "VIP", "positionX": 130, "positionY": 50 },
    { "section": "1층", "row": "A", "number": 3, "seatGrade": "VIP", "positionX": 160, "positionY": 50 },
    ...
  ]
}
```

#### 필드 설명

| 필드 | 설명 | 예시 |
|------|------|------|
| section | 구역명. 좌석배치도에서 그룹핑 단위 | "1층", "2층", "VIP구역", "스탠딩A" |
| row | 좌석 열. 같은 줄에 있는 좌석들 | "A", "B", "1", "2", "VIP1" |
| number | 좌석 번호. 열 내에서 유일해야 함 | 1, 2, 3, ... |
| seatGrade | 좌석 등급. `VenueSeatCapacity`에 정의된 등급과 일치해야 하며, 가격 책정에 사용됩니다. | VIP, R, S, A, B |
| positionX | 좌석배치도에서의 X좌표 | 100 (픽셀) |
| positionY | 좌석배치도에서의 Y좌표 | 50 (픽셀) |

#### 좌표(positionX, positionY) 설명

좌석배치도를 렌더링할 때 사용하는 좌표입니다.

```
     0                    400                   800
     ├──────────────────────┼──────────────────────┤ → X축
   0 ┌─────────────────────────────────────────────┐
     │                  [ 무 대 ]                   │
  50 ├─────────────────────────────────────────────┤
     │  (100,80)  (130,80)  (160,80)  ...          │  A열
 100 │  (100,110) (130,110) (160,110) ...          │  B열
 150 │  (100,140) (130,140) (160,140) ...          │  C열
     │                                             │
 400 └─────────────────────────────────────────────┘
     ↓
     Y축
```

**협의 필요:**
- 좌표 단위: 픽셀(px)? 상대값(%)?
- 좌석 크기: 고정값? 줌 레벨에 따라 가변?
- 좌석 간격: BE에서 계산? FE에서 자유 배치?

---

### 3단계: 기획사 (Company) 등록

공연을 주최하는 기획사 정보를 등록합니다.

```
POST /api/admin/companies
{
  "name": "카피인액션",
  "ceoName": "홍길동",
  "businessNumber": "123-45-67890",
  "email": "hello@example.com",
  "contact": "02-9876-5432",
  "address": "서울시 강남구...",
  "performanceInquiry": "concert@example.com"
}
```

---

### 4단계: 공연 등록

공연 정보와 함께 관련 기획사 정보를 연결합니다.

```
POST /api/admin/performances
{
  "title": "2025 HYOLYN CONCERT",
  "description": "효린 단독 콘서트",
  "category": "CONCERT",
  "runningTime": 120,
  "ageRating": "전체 관람가",
  "venueId": 1,
  "companyId": 1, // 새로 추가된 필드: 기획사 ID
  "actors": "효린, 댄서팀", // 새로 추가된 필드
  "agency": "스타쉽 엔터테인먼트", // 새로 추가된 필드
  "producer": "콘서트 기획팀", // 새로 추가된 필드
  "host": "주최사", // 새로 추가된 필드
  "discountInfo": "조기 예매 10% 할인", // 새로 추가된 필드
  "usageGuide": "공연 30분 전부터 입장 가능", // 새로 추가된 필드
  "refundPolicy": "구매 후 7일까지 취소 가능", // 새로 추가된 필드
  "detailImageUrl": "http://example.com/detail_image.jpg", // 새로 추가된 필드
  "startDate": "2025-12-25",
  "endDate": "2025-12-26"
}
```

---

### 5단계: 공연 회차 등록

공연 일시, 판매 시작 일시와 함께 해당 회차에 대한 티켓 가격 정책을 설정합니다. `TicketOption`은 이제 `PerformanceSchedule`에 직접 연결됩니다.

```
POST /api/admin/performances/{performanceId}/schedules
{
  "showDatetime": "2025-12-25T14:00:00",
  "saleStartDatetime": "2025-12-01T10:00:00",
  "ticketOptions": [ // 회차별 티켓 옵션
    {
      "seatGrade": "VIP",    // 좌석 등급 (VenueSeatCapacity 및 Seat의 등급과 일치)
      "price": 150000        // 해당 등급의 티켓 가격
    },
    {
      "seatGrade": "R",
      "price": 120000
    },
    {
      "seatGrade": "S",
      "price": 90000
    }
  ]
}
```

---

### 6단계: 회차별 좌석 초기화 ⚠️ (설계 중)

> **Note:** 이 단계는 2단계(좌석 등록) 재설계 완료 후 구현 예정입니다.

공연장의 좌석(Seat) 마스터 데이터를 해당 회차의 좌석(ScheduleSeat)으로 복사합니다. 이 과정에서 각 좌석의 등급(`seatGrade`)에 맞는 회차별 티켓 옵션(`ticketOption`)이 자동으로 연결됩니다.

```
POST /api/admin/schedules/{scheduleId}/seats/initialize
{
  "scheduleId": 1 // 초기화할 회차 ID
}
```

**설명:**
- `scheduleId`로 지정된 공연 회차에 대해, 해당 회차가 열리는 공연장(`venueId`)에 등록된 모든 `Seat` 마스터 데이터를 복사하여 `ScheduleSeat`를 생성합니다.
- 복사 시, 각 `ScheduleSeat`의 `seatGrade`에 해당하는 `ticketOptionId`는 5단계에서 등록한 회차별 `TicketOption` 정보를 바탕으로 자동 매핑됩니다.
- 모든 초기화된 `ScheduleSeat`의 상태는 `AVAILABLE`로 설정됩니다.

---

### 7단계: 공연 노출

```
PATCH /api/admin/performances/{performanceId}
{
  "visible": true
}
```

---

## FE 협의가 필요한 부분

### 1. 좌석배치도 렌더링 방식 및 좌석 데이터 연동

| 옵션 | 설명 | 장점 | 단점 |
|------|------|------|------|
| A. 정적 이미지 | seatingChartUrl 이미지만 표시 | 단순함 | 좌석 클릭 불가 |
| B. SVG 동적 생성 | `positionX/Y`와 `VenueSeatCapacity`의 정보를 활용하여 좌석 렌더링 | 인터랙티브, 상세 제어 | FE 구현 복잡 |
| C. 이미지 + 오버레이 | 이미지 위에 클릭 영역 배치 | 실제감 | 좌표 맞추기 어려움, 반응형 대응 복잡 |

**현재 BE 설계는 `Seat` 엔티티의 `positionX/Y` 데이터를 활용한 옵션 B (SVG 동적 생성)를 가정하고 있습니다.**
`VenueSeatCapacity`로 등급별 총 좌석 수를 관리하고, `Seat` 엔티티로 개별 좌석의 위치를 관리하므로 FE에서는 이 두 정보를 조합하여 배치도를 구성해야 합니다.

### 2. 좌석 등록 UI (관리자용)

관리자가 개별 좌석을 어떻게 등록할 것인지에 대한 UI/UX 협의가 필요합니다. `positionX/Y` 좌표를 입력하는 방식은 FE 구현 복잡도를 높일 수 있습니다.

| 옵션 | 설명 |
|------|------|
| A. 수동 입력 | 관리자가 직접 좌표 입력 (비효율적) |
| B. 드래그 앤 드롭 에디터 | 캔버스에서 좌석 배치 및 좌표 자동 저장 (FE 구현 복잡도 매우 높음) |
| C. CSV/Excel 업로드 | 미리 작성된 좌석 데이터를 일괄 등록 (가장 현실적인 MVP) |
| D. 템플릿 생성 | "10x20 그리드"와 같은 패턴으로 좌석 자동 생성 후 수정 (초기 좌석 세팅 효율화) |

### 3. 줌/팬 기능

대형 공연장(수천 석)의 경우 좌석 선택 시 줌/팬 기능이 필수적입니다.

- 사용할 라이브러리? (e.g., `react-zoom-pan-pinch`, `d3.js`, `Konva.js`)
- 줌 레벨에 따른 좌석 표시 방식 (좌석 크기, 정보 표시 등)?
- 모바일 터치(핀치 줌, 스크롤) 지원 여부?

### 4. 좌석 상태 표시 (컬러 팔레트)

사용자에게 좌석 상태(선택 가능, 선택 중, 예매 완료, 장애인석 등)를 명확하게 전달하기 위한 컬러 팔레트 및 디자인 협의가 필요합니다.

```
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ AVAILABLE│  │  HELD   │  │ RESERVED │  │ACCESSIBLE│  │  BLOCKED  │
│  (회색)  │  │ (노란색) │  │  (빨간색) │  │  (파란색) │  │ (어두운 회색) │
│ 선택가능 │  │ 선택중  │  │ 예매완료 │  │ 장애인석 │  │ 판매불가 │
└─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘
```

### 5. 실시간 좌석 업데이트

다른 사용자가 좌석을 선택하거나 해제할 때 실시간으로 좌석 상태가 반영되어야 합니다.

```
GET /api/schedules/{scheduleId}/seats/events  (SSE)
```

### 6. 이미지 업로드 (MinIO)

공연 상세 이미지, 포스터 등 이미지를 업로드하고 관리하는 기능이 필요합니다.

- MinIO를 통한 파일 업로드 API 연동 방식 (`FileController` 예정)
- 이미지 미리보기, 다중 이미지 업로드 지원 여부
- 업로드된 이미지 URL을 공연(Performance) 정보와 연동하는 방식

### 7. 지도 API 연동

공연장 위치를 지도에 표시하는 기능 구현을 위해 지도 API (Kakao/Naver/Google Maps) 연동이 필요합니다.

- `Venue` 엔티티의 `latitude`, `longitude` 필드 활용
- 프론트엔드에서 지도 API 라이브러리 연동 및 마커 표시, 정보창(Infowindow) 등의 UI 구현
- 지도 서비스 제공자 선택 및 API 키 관리 방안

---

## 데이터 관계도

```
Venue (공연장)
  │
  ├── seatingChartUrl (좌석배치도 이미지)
  ├── phoneNumber (대표번호)
  │
  ├── VenueSeatCapacity (등급별 허용 좌석수)
  │     - seatGrade: VIP
  │     - capacity: 100
  │
  └── Seat (좌석 마스터) ──────────────────────────────────────────────────┐
        - section: "1층"                                                  │
        - row: "A"                                                       │
        - number: 1                                                      │
        - seatGrade: VIP (VenueSeatCapacity의 등급과 일치)                  │
        - positionX: 100                                                  │
        - positionY: 50                                                   │
                                                                          │
Company (기획사) ──────────────────────────┐                               │
  - name: "카피인액션"                     │                               │
  - ceoName: "홍길동"                      │                               │
  - businessNumber: "123-45-67890"         │                               │
  - email: "hello@example.com"             │                               │
  - contact: "02-9876-5432"                │                               │
  - address: "서울시 강남구..."             │                               │
  - performanceInquiry: "concert@..."      │                               │
                                           │                               │
Performance (공연)                         │                               │
  │                                      │                               │
  ├── venueId → Venue                      │                               │
  ├── companyId → Company (기획사)───────┘                               │
  ├── title: "2025 HYOLYN CONCERT"                                        │
  ├── description: "효린 단독 콘서트"                                     │
  ├── category: "CONCERT"                                                 │
  ├── runningTime: 120                                                    │
  ├── ageRating: "전체 관람가"                                            │
  ├── actors: "효린, 댄서팀"                                                │
  ├── agency: "스타쉽 엔터테인먼트"                                       │
  ├── producer: "콘서트 기획팀"                                           │
  ├── host: "주최사"                                                     │
  ├── discountInfo: "조기 예매 10% 할인"                                 │
  ├── usageGuide: "공연 30분 전부터 입장 가능"                           │
  ├── refundPolicy: "구매 후 7일까지 취소 가능"                           │
  ├── detailImageUrl: "http://example.com/detail_image.jpg"              │
  ├── startDate: "2025-12-25"                                             │
  ├── endDate: "2025-12-26"                                               │
  │                                                                        │
  └── PerformanceSchedule (회차) ──────────────────────────────────────────┐
        │                                                                │
        ├── showDatetime: "2025-12-25T14:00:00"                          │
        ├── saleStartDatetime: "2025-12-01T10:00:00"                     │
        │                                                                │
        └── TicketOption (회차별 티켓 옵션)                                │
              - seatGrade: VIP                                            │
              - price: 150000                                             │
              │                                                           │
              └── ScheduleSeat (회차별 좌석) ←──────────────────────────┘
                    - seatId → Seat (복사)
                    - ticketOptionId → TicketOption (회차별 가격 매핑)
                    - status: AVAILABLE/HELD/RESERVED
                    - heldUntil: (점유 만료 시간)
```

---

## DDD 리팩토링 (향후 과제)

본 백엔드 프로젝트는 도메인 주도 설계(DDD) 원칙을 따르며, 코드 품질 개선을 위해 다음과 같은 리팩토링을 예정하고 있습니다. 이는 현재 플로우 문서에 직접적인 변경을 가하지는 않지만, 관련 개발 시 고려되어야 합니다.

*   **DTO `toEntity()` 제거 → Domain 팩토리 메서드 전환:**
    *   `CreateVenueRequest.toEntity()` 와 같은 DTO의 엔티티 변환 로직을 제거하고, `Venue.create()`와 같이 도메인 엔티티 자체에서 생성 메서드를 제공하도록 변경합니다. 이는 도메인 객체의 생성 제어를 강화하고, 비즈니스 로직이 DTO에 의존하는 것을 방지합니다.
*   **풍부한 도메인 모델 적용:**
    *   현재 서비스(Service) 계층에 집중되어 있는 비즈니스 로직의 일부를 도메인 엔티티 내부로 이동시켜 도메인 모델을 더욱 풍부하게 만듭니다.
    *   도메인 객체 내부에서 데이터의 일관성과 유효성을 검증하는 로직을 캡슐화하여 비즈니스 규칙이 강제되도록 합니다.
*   **Domain Event 도입 검토:**
    *   도메인 내에서 발생하는 중요한 상태 변경이나 비즈니스 이벤트를 `Domain Event`로 발행하고, 이를 처리하는 핸들러를 도입하여 도메인 간의 느슨한 결합을 유도합니다.