# 좌석 예매 시스템 가이드

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0  | 2025-12-10 | BE | 초안 작성 |
| 1.1  | 2025-12-18 | Gemini | 최신 구현 내용(JSON 기반 좌석 시스템, ScheduleSeatStatus 중심)을 반영하여 ERD, API 엔드포인트, 예매 흐름, 동시성 처리, Admin 좌석 관리, 실시간 업데이트, 오류 처리, 프로젝트 구조 전반 업데이트. |
| 1.2  | 2025-12-18 | BE | 좌석 배치도 저장 API 통합 (seatingChart + seatCapacities 동시 저장) |
| 1.3  | 2025-12-18 | BE | seatingChart 타입을 String에서 JSON Object로 변경 (프론트 편의성 개선) |
| 1.4  | 2025-12-18 | BE | 등급별 좌석수 별도 CRUD API 제거 (배치도 저장 API에 통합) |

## 목차

1. [개요](#1-개요)
2. [데이터 모델](#2-데이터-모델)
3. [API 엔드포인트](#3-api-엔드포인트)
4. [예매 흐름](#4-예매-흐름)
5. [동시성 처리](#5-동시성-처리)
6. [Admin 좌석 관리](#6-admin-좌석-관리)
7. [실시간 업데이트](#7-실시간-업데이트)
8. [오류 처리](#8-오류-처리)
9. [부록: 프로젝트 구조](#9-부록-프로젝트-구조)

---

## 1. 개요

본 시스템은 **개별 좌석 선택 방식**의 공연 예매를 지원합니다 (영화관 방식).

### 핵심 개념

| 개념 | 설명 | 현재 코드 매핑 |
|------|------|----------------|
| Venue | 공연장 | `Venue` 엔티티 |
| VenueSeatCapacity | 공연장 등급별 허용 좌석수 | `VenueSeatCapacity` 엔티티 |
| Performance | 공연 | `Performance` 엔티티 |
| PerformanceSchedule | 공연 회차 | `PerformanceSchedule` 엔티티 |
| ScheduleSeatStatus | 회차별 개별 좌석 상태 | `ScheduleSeatStatus` 엔티티 |
| Reservation | 예매 | (현재 미구현) |
| TicketOption | 공연 회차별 티켓 옵션 | `TicketOption` 엔티티 |

### 주요 특징

- **개별 좌석 선택**: 좌석배치도에서 원하는 좌석 클릭
- **임시 점유 (PENDING)**: 결제 전 10분간 좌석 선점 (`ScheduleSeatStatus`의 `PENDING` 상태)
- **최대 4석 제한**: 1인당 최대 4석까지 선택 가능 (SeatService 로직)
- **좌석 상태 폴링**: `GET /api/schedules/{scheduleId}/seat-status`를 통한 좌석 상태 업데이트 (SSE 미구현)

## 2. 데이터 모델

### 2.1 테이블 설명 (현재 구현 기준)

#### `ScheduleSeatStatus` (회차별 좌석 상태)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | BIGSERIAL | PK |
| schedule_id | BIGINT | 공연 회차 FK |
| row_num | INT | 좌석 행 번호 |
| col_num | INT | 좌석 열 번호 |
| status | VARCHAR(20) | 상태 (PENDING/RESERVED) |
| held_until | TIMESTAMP | 임시 점유 만료 시간 |
| held_by | BIGINT | 임시 점유한 회원 ID |

**UNIQUE 제약조건:** (schedule_id, row_num, col_num)

## 3. API 엔드포인트

### 3.1 공연장 및 좌석 배치 관리 API (Admin)

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| POST | `/api/admin/venues` | 새 공연장 생성 | ADMIN |
| GET | `/api/venues/{id}` | 특정 공연장 정보 조회 | 누구나 |
| PUT | `/api/venues/{id}` | 특정 공연장 정보 수정 | ADMIN |
| DELETE | `/api/venues/{id}` | 특정 공연장 삭제 | ADMIN |
| GET | `/api/venues/{id}/seating-chart` | 공연장 좌석 배치도 + 등급별 좌석수 조회 | 누구나 |
| PUT | `/api/admin/venues/{id}/seating-chart` | 공연장 좌석 배치도 + 등급별 좌석수 저장/수정 (통합 API) | ADMIN |

### 3.2 공연 회차 API (Admin)

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| POST | `/api/admin/performances/{performanceId}/schedules` | 특정 공연에 대한 새 회차 생성 | ADMIN |
| GET | `/api/admin/schedules/{scheduleId}` | ID로 특정 공연 회차 정보 조회 | ADMIN |
| GET | `/api/admin/performances/{performanceId}/schedules` | 특정 공연의 모든 회차 목록 조회 | ADMIN |
| PUT | `/api/admin/schedules/{scheduleId}` | 특정 공연 회차 정보 수정 | ADMIN |
| DELETE | `/api/admin/schedules/{scheduleId}` | 특정 공연 회차 삭제 | ADMIN |

### 3.3 좌석 상태 관리 API (사용자)

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| GET | `/api/schedules/{scheduleId}/seat-status` | 회차별 좌석 상태 조회 (PENDING, RESERVED 좌석 반환) | 누구나 |
| POST | `/api/schedules/{scheduleId}/seats/hold` | 좌석 점유 (최대 4석, 10분) | USER, ADMIN |
| DELETE | `/api/schedules/{scheduleId}/seats/hold` | 좌석 점유 해제 | USER, ADMIN |
| POST | `/api/schedules/{scheduleId}/seats/reserve` | 좌석 예약 확정 (결제 완료 후) | USER, ADMIN |


## 4. 예매 흐름 (현재 구현 기준)

### 4.1 사용자 좌석 점유/예약 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 공연 및 회차 선택                                            │
│     GET /api/performances/{id}                                  │
│     GET /api/admin/performances/{performanceId}/schedules       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 좌석 배치도 및 실시간 좌석 상태 조회                           │
│     GET /api/venues/{venueId}/seating-chart (좌석 배치도 JSON)  │
│     GET /api/schedules/{scheduleId}/seat-status (좌석 상태)     │
│     → FE에서 두 정보를 조합하여 좌석 배치도 렌더링                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 좌석 선택 (최대 4석)                                         │
│     POST /api/schedules/{scheduleId}/seats/hold                 │
│     {                                                           │
│       "seats": [ {"row": 1, "col": 1}, {"row": 1, "col": 2} ]   │
│     }                                                           │
│                                                                 │
│     → 10분간 좌석 점유 (PENDING 상태)                             │
│     → 타이머 시작 (FE에서 관리, BE는 held_until 필드)             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. (결제 완료 후) 좌석 예약 확정                                │
│     POST /api/schedules/{scheduleId}/seats/reserve              │
│     → 좌석 상태: PENDING → RESERVED                             │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 좌석 점유 만료 처리

```
┌─────────────────────────────────────────────────────────────────┐
│  SeatService.cleanupExpiredHolds() 메서드 호출                    │
│                                                                 │
│  1. held_until < 현재시간 인 PENDING 상태 좌석 조회               │
│  2. 해당 좌석들 상태 변경: PENDING → AVAILABLE (삭제)             │
│                                                                 │
│  ※ 현재는 이 메서드를 주기적으로 호출하는 스케줄러가 구현되지 않음.  │
│     향후 스케줄러 구현 필요.                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 5. 동시성 처리

### 5.1 비관적 락 (Pessimistic Lock)

동시에 여러 사용자가 같은 좌석을 선택할 때 **데이터 정합성**을 보장합니다. `ScheduleSeatStatus` 엔티티를 대상으로 락을 사용합니다.

```kotlin
// ScheduleSeatStatusRepository
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT s FROM ScheduleSeatStatus s WHERE s.schedule.id = :scheduleId AND s.rowNum = :rowNum AND s.colNum = :colNum")
fun findByScheduleIdAndRowNumAndColNumWithLock(@Param("scheduleId") scheduleId: Long, @Param("rowNum") rowNum: Int, @Param("colNum") colNum: Int): ScheduleSeatStatus?
```

### 5.2 좌석 점유 시 동작

`SeatService.holdSeats` 메서드 내에서 비관적 락을 활용하여 좌석 점유 시 동시성을 제어합니다.

```kotlin
@Transactional
fun holdSeats(scheduleId: Long, userId: Long, seats: List<SeatPositionRequest>): SeatHoldResponse {
    // ...
    for (seat in seats) {
        val existingSeat = seatStatusRepository.findByScheduleIdAndRowNumAndColNumWithLock(
            scheduleId, seat.row, seat.col
        )
        // ... 점유 로직
    }
    // ...
}
```
**참고**: `SeatService` 내에서 최대 좌석 수 제한(4석) 로직을 처리합니다.

## 6. Admin 좌석 관리

### 6.1 좌석 배치도 + 등급별 좌석수 통합 저장

Admin은 `PUT /api/admin/venues/{venueId}/seating-chart` API를 통해 **좌석 배치도 JSON과 등급별 좌석 수를 한 번에 저장**합니다.

```http
PUT /api/admin/venues/{venueId}/seating-chart
Content-Type: application/json
{
  "seatingChart": {
    "sections": [
      {
        "name": "1층",
        "rows": [
          { "name": "A", "seats": [...] }
        ]
      }
    ]
  },
  "seatCapacities": [
    { "seatGrade": "VIP", "capacity": 100 },
    { "seatGrade": "R", "capacity": 200 }
  ]
}
```

- `seatingChart`는 **JSON 객체**로 전달 (이스케이프 불필요)
- `seatCapacities`가 전달되면 기존 좌석 용량을 삭제 후 새로 저장
- `seatCapacities`가 `null`이면 배치도만 저장 (기존 좌석 용량 유지)
- DB에는 JSON 문자열로 저장, API 요청/응답은 JSON 객체로 처리

### 6.2 회차별 가격 설정

가격은 회차(PerformanceSchedule) 생성 시 `ticketOptions`로 설정합니다.

```http
POST /api/admin/performances/{performanceId}/schedules
Content-Type: application/json
{
  "showDateTime": "2025-12-25T14:00:00",
  "saleStartDateTime": "2025-12-01T10:00:00",
  "ticketOptions": [
    { "seatGrade": "VIP", "price": 150000 },
    { "seatGrade": "R", "price": 120000 }
  ]
}
```

개별 좌석을 직접 등록하는 API는 존재하지 않습니다. 좌석 상태 조회는 사용자 API와 동일합니다.

---

## 7. 실시간 업데이트

현재 좌석 상태의 실시간 업데이트는 `GET /api/schedules/{scheduleId}/seat-status` API를 프론트엔드에서 **주기적으로 폴링(polling)**하는 방식으로 구현을 고려하고 있습니다. SSE (Server-Sent Events)를 이용한 실시간 업데이트는 현재 **미구현** 상태입니다.

---

## 8. 오류 처리

주요 에러 코드 목록 (일부)

| HTTP | 코드 | 설명 |
|------|----------|------|
| 400 | INVALID_INPUT_VALUE | 입력 값이 올바르지 않습니다. |
| 400 | SEAT_HOLD_EXPIRED | 좌석 점유 시간이 만료되었습니다. |
| 400 | SEAT_LIMIT_EXCEEDED | 최대 선택 가능 좌석 수(4석)를 초과했습니다. |
| 400 | NO_SEATS_TO_RESERVE | 예약할 좌석이 없습니다. 먼저 좌석을 선택해주세요. |
| 403 | ACCESS_DENIED | 접근 권한이 없습니다. |
| 404 | PERFORMANCE_SCHEDULE_NOT_FOUND | 해당 공연 회차를 찾을 수 없습니다. |
| 409 | SEAT_ALREADY_OCCUPIED | 이미 점유 또는 예약된 좌석입니다. |
| 409 | PERFORMANCE_SCHEDULE_PERFORMANCE_CANNOT_CHANGE | 공연 회차의 공연 정보는 변경할 수 없습니다. |

### 오류 응답 예시

```json
{
  "status": 409,
  "code": "SEAT_ALREADY_OCCUPIED",
  "message": "이미 점유 또는 예약된 좌석입니다."
}
```

---

## 9. 부록: 프로젝트 구조 (좌석 관련)

```
src/main/kotlin/com/github/copyinaction/
├── venue/
│   ├── domain/
│   │   ├── Venue.kt
│   │   ├── VenueSeatCapacity.kt
│   │   └── SeatGrade.kt (enum)
│   ├── repository/
│   │   ├── VenueRepository.kt
│   │   └── VenueSeatCapacityRepository.kt
│   ├── service/
│   │   └── VenueService.kt
│   ├── controller/
│   │   └── VenueController.kt
│   └── dto/
│       ├── VenueDto.kt
│       └── VenueSeatCapacityDto.kt
└── seat/
    ├── domain/
    │   ├── ScheduleSeatStatus.kt
    │   └── SeatStatus.kt (enum)
    ├── repository/
    │   └── ScheduleSeatStatusRepository.kt
    ├── service/
    │   └── SeatService.kt
    ├── controller/
    │   └── SeatController.kt
    └── dto/
        └── SeatDto.kt

```
(참고: `Reservation` 관련 도메인 및 서비스는 현재 코드베이스에 존재하지 않으므로 구조에서 제외합니다.)
