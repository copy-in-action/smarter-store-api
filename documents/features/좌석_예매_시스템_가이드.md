# 좌석 예매 시스템 가이드

## 목차

1. [개요](#1-개요)
2. [데이터 모델](#2-데이터-모델)
3. [API 엔드포인트](#3-api-엔드포인트)
4. [예매 흐름](#4-예매-흐름)
5. [동시성 처리](#5-동시성-처리)
6. [Admin 좌석 관리](#6-admin-좌석-관리)
7. [실시간 업데이트 (SSE)](#7-실시간-업데이트-sse)
8. [오류 처리](#8-오류-처리)

---

## 1. 개요

본 시스템은 **개별 좌석 선택 방식**의 공연 예매를 지원합니다 (영화관 방식).

### 핵심 개념

| 개념 | 설명 | 예시 |
|------|------|------|
| Venue | 공연장 | 올림픽공원 올림픽홀 |
| Seat | 공연장 좌석 (고정) | VIP구역 A-1 |
| Performance | 공연 | 2025 HYOLYN CONCERT |
| PerformanceSchedule | 공연 회차 | 12/25 14:00, 12/25 19:00 |
| ScheduleSeat | 회차별 좌석 상태 | 12/25 14:00 VIP구역 A-1 (AVAILABLE) |
| Reservation | 예매 | 예매번호 R20251225140001 |

### 주요 특징

- **개별 좌석 선택**: 좌석배치도에서 원하는 좌석 클릭
- **임시 점유 (HELD)**: 결제 전 10분간 좌석 선점
- **최대 4석 제한**: 1인당 최대 4석까지 선택 가능
- **실시간 업데이트**: SSE를 통한 좌석 상태 실시간 반영

---

## 2. 데이터 모델

### 2.1 ERD

```
┌─────────────────┐         ┌─────────────────────┐
│      Venue      │─────────│        Seat         │
├─────────────────┤   1:N   ├─────────────────────┤
│ id              │         │ id                  │
│ name            │         │ venue_id (FK)       │
│ address         │         │ section             │
│ seatingChartUrl │         │ seat_row            │
└─────────────────┘         │ seat_number         │
                            │ seat_grade          │
                            │ position_x, y       │
                            └─────────────────────┘
                                      │
                                      │ 1:N
                                      ▼
┌─────────────────┐         ┌─────────────────────────┐
│   Performance   │         │     ScheduleSeat        │
├─────────────────┤         ├─────────────────────────┤
│ id              │         │ id                      │
│ title           │         │ schedule_id (FK)        │
│ venue_id (FK)   │         │ seat_id (FK)            │
└─────────────────┘         │ ticket_option_id (FK)   │
        │                   │ status                  │
        │ 1:N               │ held_until              │
        ▼                   │ held_by_user_id         │
┌───────────────────────┐   │ held_by_session_id      │
│ PerformanceSchedule   │   │ version                 │
├───────────────────────┤   └─────────────────────────┘
│ id                    │             │
│ performance_id (FK)   │─────────────┘
│ show_datetime         │             │ 1:N
└───────────────────────┘             ▼
                            ┌─────────────────────────┐
┌─────────────────┐         │    ReservationSeat      │
│  TicketOption   │         ├─────────────────────────┤
├─────────────────┤         │ id                      │
│ id              │         │ reservation_id (FK)     │
│ performance_id  │         │ schedule_seat_id (FK)   │
│ name (VIP, R석) │         └─────────────────────────┘
│ price           │                   │
└─────────────────┘                   │
                                      │
                            ┌─────────────────────────┐
                            │      Reservation        │
                            ├─────────────────────────┤
                            │ id                      │
                            │ reservation_number      │
                            │ schedule_id (FK)        │
                            │ user_id                 │
                            │ user_name, phone, email │
                            │ quantity                │
                            │ total_price             │
                            │ status                  │
                            └─────────────────────────┘
```

### 2.2 테이블 설명

#### seat (공연장 좌석)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | BIGSERIAL | PK |
| venue_id | BIGINT | 공연장 FK |
| section | VARCHAR(50) | 구역 (1층, VIP구역 등) |
| seat_row | VARCHAR(10) | 좌석 열 (A, B, VIP1 등) |
| seat_number | INT | 좌석 번호 |
| seat_grade | VARCHAR(20) | 좌석 등급 (VIP, R, S, A, STANDARD) |
| position_x | INT | 좌석배치도 X좌표 |
| position_y | INT | 좌석배치도 Y좌표 |

**UNIQUE 제약조건:** (venue_id, seat_row, seat_number)

#### schedule_seat (회차별 좌석 상태)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | BIGSERIAL | PK |
| schedule_id | BIGINT | 공연 회차 FK |
| seat_id | BIGINT | 좌석 FK |
| ticket_option_id | BIGINT | 좌석등급(가격) FK |
| status | VARCHAR(20) | 상태 (AVAILABLE/HELD/RESERVED) |
| held_until | TIMESTAMP | 임시 점유 만료 시간 |
| held_by_user_id | BIGINT | 임시 점유한 회원 ID |
| held_by_session_id | VARCHAR(100) | 임시 점유한 세션 ID (비회원) |
| version | BIGINT | 낙관적 락 버전 |

**UNIQUE 제약조건:** (schedule_id, seat_id)

#### reservation_seat (예매-좌석 연결)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | BIGSERIAL | PK |
| reservation_id | BIGINT | 예매 FK |
| schedule_seat_id | BIGINT | 회차별 좌석 FK |

---

## 3. API 엔드포인트

### 3.1 공연장 좌석 관리 API (Admin)

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| POST | `/api/admin/venues/{venueId}/seats/bulk` | 좌석 일괄 생성 | ADMIN |
| POST | `/api/admin/venues/{venueId}/seats` | 좌석 단일 생성 | ADMIN |
| GET | `/api/venues/{venueId}/seats` | 좌석 목록 조회 | - |
| PUT | `/api/admin/venues/{venueId}/seats/{seatId}` | 좌석 수정 | ADMIN |
| DELETE | `/api/admin/venues/{venueId}/seats/{seatId}` | 좌석 삭제 | ADMIN |

### 3.2 회차별 좌석 API

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| POST | `/api/admin/schedules/{scheduleId}/seats/initialize` | 회차 좌석 초기화 | ADMIN |
| GET | `/api/schedules/{scheduleId}/seats` | 좌석 상태 조회 | - |
| GET | `/api/schedules/{scheduleId}/seats/summary` | 좌석 요약 조회 | - |
| GET | `/api/schedules/{scheduleId}/seats/events` | SSE 실시간 업데이트 | - |

### 3.3 좌석 점유 API

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| POST | `/api/schedules/{scheduleId}/seats/hold` | 좌석 점유 (최대 4석, 10분) | - |
| POST | `/api/schedules/{scheduleId}/seats/release` | 좌석 해제 | - |
| GET | `/api/schedules/{scheduleId}/seats/my-holds` | 내 점유 좌석 조회 | - |

### 3.4 좌석 예매 API

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| POST | `/api/reservations/seats` | 좌석 예매 생성 | - |
| POST | `/api/reservations/seats/lookup` | 예매 조회 (비회원) | - |
| GET | `/api/reservations/seats/my` | 내 예매 목록 | 로그인 |
| GET | `/api/reservations/seats/{id}` | 예매 상세 조회 | ADMIN |
| POST | `/api/reservations/seats/{id}/confirm` | 예매 확정 | ADMIN |
| POST | `/api/reservations/seats/{id}/cancel` | 예매 취소 | - |

---

## 4. 예매 흐름

### 4.1 사용자 예매 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 공연 선택                                                    │
│     GET /api/performances/{id}                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 회차 선택 후 좌석배치도 조회                                   │
│     GET /api/schedules/{scheduleId}/seats                       │
│                                                                 │
│     응답: 구역별 좌석 목록 + 상태 (AVAILABLE/HELD/RESERVED)        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. SSE 연결 (실시간 업데이트)                                    │
│     GET /api/schedules/{scheduleId}/seats/events                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 좌석 선택 (최대 4석)                                         │
│     POST /api/schedules/{scheduleId}/seats/hold                 │
│     {                                                           │
│       "scheduleSeatIds": [101, 102],                           │
│       "sessionId": "uuid-session-id"                           │
│     }                                                           │
│                                                                 │
│     → 10분간 좌석 점유 (HELD 상태)                                │
│     → 타이머 시작                                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 예매 생성                                                    │
│     POST /api/reservations/seats                                │
│     {                                                           │
│       "scheduleSeatIds": [101, 102],                           │
│       "userName": "홍길동",                                      │
│       "userPhone": "010-1234-5678",                             │
│       "userEmail": "hong@example.com"                           │
│     }                                                           │
│                                                                 │
│     → 좌석 상태: HELD → RESERVED                                 │
│     → 예매번호 발급: R20251225140001                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 결제 처리 (외부 PG 연동)                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. 예매 확정                                                    │
│     POST /api/reservations/seats/{id}/confirm                   │
│     → status: PENDING → CONFIRMED                               │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 예매 취소 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  POST /api/reservations/seats/{id}/cancel                       │
│                                                                 │
│  1. 예매 상태 확인 (이미 취소된 건 거부)                           │
│  2. 좌석 상태 복구 (비관적 락 적용)                                │
│     → RESERVED → AVAILABLE                                      │
│  3. status: → CANCELLED                                         │
│  4. cancelled_at 기록                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 점유 만료 처리

```
┌─────────────────────────────────────────────────────────────────┐
│  SeatHoldExpirationScheduler (1분마다 실행)                      │
│                                                                 │
│  1. held_until < 현재시간 인 좌석 조회                            │
│  2. 해당 좌석들 상태 변경: HELD → AVAILABLE                       │
│  3. 로그 기록                                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 동시성 처리

### 5.1 비관적 락 (Pessimistic Lock)

동시에 여러 사용자가 같은 좌석을 선택할 때 **데이터 정합성**을 보장합니다.

```kotlin
// ScheduleSeatRepository
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT s FROM ScheduleSeat s WHERE s.id IN :ids ORDER BY s.id ASC")
fun findByIdsWithLock(@Param("ids") ids: List<Long>): List<ScheduleSeat>
```

### 5.2 좌석 점유 시 동작

```kotlin
@Transactional
fun holdSeats(scheduleSeatIds: List<Long>, userId: Long?, sessionId: String?): HoldSeatsResponse {
    // 1. ID 순으로 정렬하여 락 획득 (데드락 방지)
    val sortedIds = scheduleSeatIds.sorted()

    // 2. 비관적 락으로 좌석들 조회 (다른 트랜잭션 대기)
    val seats = scheduleSeatRepository.findByIdsWithLock(sortedIds)

    // 3. 모든 좌석이 AVAILABLE 상태인지 확인
    if (seats.any { it.status != SeatStatus.AVAILABLE }) {
        throw CustomException(ErrorCode.SEAT_NOT_AVAILABLE)
    }

    // 4. 좌석 점유
    seats.forEach { seat ->
        seat.hold(userId, sessionId, 10) // 10분 점유
    }

    return HoldSeatsResponse(...)
}
```

### 5.3 동시성 시나리오

```
시간   사용자A              사용자B              좌석 A-1 상태
─────────────────────────────────────────────────────────────────
T1     좌석 A-1 점유 요청                        AVAILABLE
T2     락 획득                                   AVAILABLE
T3     상태 확인 OK          좌석 A-1 점유 요청   AVAILABLE
T4     status = HELD                             HELD (A)
T5     트랜잭션 커밋         락 대기...           HELD (A)
T6                          락 획득              HELD (A)
T7                          상태 확인 FAIL       HELD (A)
T8                          → SEAT_NOT_AVAILABLE HELD (A)

10분 후 (점유 만료)...
T9     (스케줄러 실행)                           AVAILABLE
T10                         좌석 A-1 점유 요청   AVAILABLE
T11                         락 획득              AVAILABLE
T12                         status = HELD        HELD (B)
```

---

## 6. Admin 좌석 관리

### 6.1 좌석 일괄 생성

```json
POST /api/admin/venues/1/seats/bulk
{
  "seats": [
    {
      "section": "VIP구역",
      "row": "A",
      "number": 1,
      "seatGrade": "VIP",
      "positionX": 100,
      "positionY": 50
    },
    {
      "section": "VIP구역",
      "row": "A",
      "number": 2,
      "seatGrade": "VIP",
      "positionX": 130,
      "positionY": 50
    }
  ]
}
```

### 6.2 회차별 좌석 초기화

공연 회차 생성 후, 공연장의 모든 좌석을 `ScheduleSeat`으로 초기화합니다.

```json
POST /api/admin/schedules/1/seats/initialize
{
  "seatGradeMapping": {
    "VIP": 1,      // VIP 등급 좌석 → ticketOptionId 1 (VIP석 15만원)
    "R": 2,        // R 등급 좌석 → ticketOptionId 2 (R석 12만원)
    "S": 3,        // S 등급 좌석 → ticketOptionId 3 (S석 9만원)
    "STANDARD": 3  // 일반 좌석 → ticketOptionId 3
  }
}
```

---

## 7. 실시간 업데이트 (SSE)

### 7.1 SSE 연결

```javascript
const eventSource = new EventSource('/api/schedules/1/seats/events');

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.isHeartbeat) {
    // 30초마다 하트비트 (연결 유지)
    return;
  }

  // 좌석 상태 업데이트
  updateSeatStatus(data.scheduleSeatId, data.status);
};

eventSource.onerror = (error) => {
  console.error('SSE 연결 오류:', error);
  eventSource.close();
  // 재연결 로직...
};
```

### 7.2 이벤트 데이터 형식

```json
{
  "scheduleSeatId": 101,
  "status": "HELD",
  "timestamp": "2025-12-20T10:30:00",
  "isHeartbeat": false
}
```

---

## 8. 오류 처리

| HTTP | 에러 코드 | 설명 |
|------|----------|------|
| 400 | MAX_SEATS_EXCEEDED | 최대 선택 가능 좌석 수(4석) 초과 |
| 400 | SEAT_HOLD_EXPIRED | 좌석 점유 시간 만료 |
| 400 | RESERVATION_ALREADY_CANCELLED | 이미 취소된 예매 |
| 403 | SEAT_NOT_HELD_BY_USER | 본인이 점유한 좌석이 아님 |
| 404 | SEAT_NOT_FOUND | 좌석 정보 없음 |
| 404 | SCHEDULE_SEAT_NOT_FOUND | 회차별 좌석 정보 없음 |
| 404 | RESERVATION_NOT_FOUND | 예매 정보 없음 |
| 409 | SEAT_NOT_AVAILABLE | 이미 선택된 좌석 |
| 409 | SEAT_ALREADY_EXISTS | 중복 좌석 생성 시도 |
| 409 | SCHEDULE_SEATS_ALREADY_INITIALIZED | 이미 초기화된 회차 |

### 오류 응답 예시

```json
{
  "status": 409,
  "code": "SEAT_NOT_AVAILABLE",
  "message": "이미 선택된 좌석입니다."
}
```

---

## 부록: 프로젝트 구조

```
src/main/kotlin/com/github/copyinaction/
├── venue/
│   ├── domain/
│   │   ├── Venue.kt
│   │   ├── Seat.kt
│   │   └── SeatGrade.kt (enum)
│   ├── repository/
│   │   ├── VenueRepository.kt
│   │   └── SeatRepository.kt
│   ├── service/
│   │   ├── VenueService.kt
│   │   └── SeatService.kt
│   ├── controller/
│   │   ├── VenueController.kt
│   │   └── SeatController.kt
│   └── dto/
│       ├── VenueDto.kt
│       └── SeatDto.kt
└── reservation/
    ├── domain/
    │   ├── ScheduleSeat.kt
    │   ├── SeatStatus.kt (enum)
    │   ├── ReservationSeat.kt
    │   ├── Reservation.kt
    │   └── ReservationStatus.kt (enum)
    ├── repository/
    │   ├── ScheduleSeatRepository.kt
    │   ├── ReservationSeatRepository.kt
    │   └── ReservationRepository.kt
    ├── service/
    │   ├── ScheduleSeatService.kt
    │   ├── SeatHoldService.kt
    │   ├── SeatReservationService.kt
    │   └── SeatEventService.kt
    ├── controller/
    │   ├── ScheduleSeatController.kt
    │   └── SeatEventController.kt
    ├── scheduler/
    │   └── SeatHoldExpirationScheduler.kt
    └── dto/
        ├── ScheduleSeatDto.kt
        └── SeatReservationDto.kt
```
