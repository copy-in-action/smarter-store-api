# 공연(Performance) 기능 추가 가이드

## 1. 개요

공연 정보(콘서트, 뮤지컬 등)를 관리하는 기능을 추가합니다.
이 문서는 해당 기능의 데이터베이스 구조, API 엔드포인트, 코드 구조를 설명하여 협업 개발자가 기능을 이해하고 사용할 수 있도록 돕는 것을 목적으로 합니다.

---

## 2. 데이터 구조 및 연관 관계

공연 정보를 효율적으로 관리하기 위해 데이터를 4개의 테이블로 정규화하여 설계했습니다.

- `venue`: 공연 장소 정보
- `performance`: 공연의 핵심 정보 (부모)
- `performance_schedule`: 공연의 특정 회차(날짜/시간) 정보 (자식)
- `ticket_option`: 공연의 티켓 종류(좌석 등급) 및 가격 정보 (자식)

### ERD (텍스트 기반)

```
[venue] 1--* [performance] *--1 [performance_schedule]
                       |
                       *--1 [ticket_option]
```

### 테이블 상세

#### 2.1. `venue`

공연 장소 정보를 저장합니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 공연장 ID |
| `name` | `VARCHAR(100)` | 공연장 이름 |
| `address` | `VARCHAR(255)` | 주소 |
| `seating_chart_url` | `VARCHAR(255)`| 좌석 배치도 URL |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.2. `performance`

공연의 고유 정보를 저장합니다. `venue` 테이블과 다대일(N:1) 관계를 가집니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 공연 ID |
| `title` | `VARCHAR(255)`| 공연명 |
| `description` | `TEXT` | 공연 상세 설명 |
| `category` | `VARCHAR(50)` | 카테고리 (e.g., '콘서트') |
| `running_time`| `INT` | 공연 시간 (분) |
| `age_rating` | `VARCHAR(50)` | 관람 연령 |
| `main_image_url` |`VARCHAR(255)`| 대표 이미지 URL |
| `venue_id` | `BIGINT` | FK, `venue` 테이블 ID |
| `start_date` | `DATE` | 공연 시작일 |
| `end_date` | `DATE` | 공연 종료일 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.3. `performance_schedule`

`performance`에 종속되는 특정 회차(날짜/시간) 정보를 저장합니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 스케줄 ID |
| `performance_id`| `BIGINT` | FK, `performance` 테이블 ID |
| `show_datetime` | `TIMESTAMP` | 공연 날짜 및 시간 |
| `sale_start_datetime` | `TIMESTAMP` | 티켓 판매 시작 시각 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.4. `ticket_option`

`performance`에 종속되는 티켓 종류(e.g., R석, S석)와 가격 정보를 저장합니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 티켓 옵션 ID |
| `performance_id`| `BIGINT` | FK, `performance` 테이블 ID |
| `name` | `VARCHAR(100)`| 티켓/좌석 등급명 |
| `price` | `DECIMAL(10,2)`| 가격 |
| `total_quantity`| `INT` | 총 판매 가능 수량 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

---

## 3. API 엔드포인트

공연장(`venues`)과 공연(`performances`)을 관리하기 위한 CRUD API 엔드포인트가 추가되었습니다.

### 3.1. 공연장 API (`/api/venues`)

| Method | URL | 권한 | 설명 |
|---|---|---|---|
| `POST` | `/` | ADMIN | 새 공연장 생성 |
| `GET` | `/{id}` | 누구나 | 특정 공연장 정보 조회 |
| `GET` | `/` | 누구나 | 모든 공연장 목록 조회 |
| `PUT` | `/{id}` | ADMIN | 특정 공연장 정보 수정 |
| `DELETE` | `/{id}` | ADMIN | 특정 공연장 삭제 |

### 3.2. 공연 API (`/api/performances`)

| Method | URL | 권한 | 설명 |
|---|---|---|---|
| `POST` | `/` | ADMIN | 새 공연 생성 |
| `GET` | `/{id}` | 누구나 | 특정 공연 정보 조회 |
| `GET` | `/` | 누구나 | 모든 공연 목록 조회 |
| `PUT` | `/{id}` | ADMIN | 특정 공연 정보 수정 |
| `DELETE`| `/{id}` | ADMIN | 특정 공연 삭제 |

> **참고**: `performance_schedule`과 `ticket_option`은 `performance`의 하위 정보로 간주하여, 별도의 Controller 없이 `PerformanceService` 내에서 로직을 통해 관리하는 것을 목표로 합니다. (현재는 관련 로직이 추가 구현되어야 함)

---

## 4. 코드 구조

기능 추가와 함께 생성된 주요 파일 목록입니다. 기존 프로젝트 구조와 컨벤션을 따랐습니다.

- **Migration**:
  - `src/main/resources/db/migration/V4__Create_performance_related_tables.sql`
- **Domain (Entity)**:
  - `src/main/kotlin/com/github/copyinaction/domain/Venue.kt`
  - `src/main/kotlin/com/github/copyinaction/domain/Performance.kt`
  - `src/main/kotlin/com/github/copyinaction/domain/PerformanceSchedule.kt`
  - `src/main/kotlin/com/github/copyinaction/domain/TicketOption.kt`
- **DTO**:
  - `src/main/kotlin/com/github/copyinaction/dto/VenueDto.kt`
  - `src/main/kotlin/com/github/copyinaction/dto/PerformanceDto.kt`
  - `src/main/kotlin/com/github/copyinaction/dto/PerformanceScheduleDto.kt`
  - `src/main/kotlin/com/github/copyinaction/dto/TicketOptionDto.kt`
- **Repository**:
  - `src/main/kotlin/com/github/copyinaction/repository/VenueRepository.kt`
  - `src/main/kotlin/com/github/copyinaction/repository/PerformanceRepository.kt`
  - `src/main/kotlin/com/github/copyinaction/repository/PerformanceScheduleRepository.kt`
  - `src/main/kotlin/com/github/copyinaction/repository/TicketOptionRepository.kt`
- **Service**:
  - `src/main/kotlin/com/github/copyinaction/service/VenueService.kt`
  - `src/main/kotlin/com/github/copyinaction/service/PerformanceService.kt`
- **Controller**:
  - `src/main/kotlin/com/github/copyinaction/controller/VenueController.kt`
  - `src/main/kotlin/com/github/copyinaction/controller/PerformanceController.kt`
- **Exception**:
  - `ErrorCode.kt`에 `VENUE_NOT_FOUND`, `PERFORMANCE_NOT_FOUND` 추가
- **Config**:
  - `SecurityConfig.kt`에 신규 GET 엔드포인트 공개 접근 허용 설정 추가

---
