## 이메일 인증 프로세스 가이드

이 문서는 Smarter Store API에 구현된 이메일 인증 프로세스를 설명합니다. 회원가입 시 이메일 유효성 확인이 주 목적입니다.

---

### 목차

1.  [개요](#1-개요)
2.  [프로세스 참여자](#2-프로세스-참여자)
3.  [프로세스 흐름](#3-프로세스-흐름)
    *   [3.1. 1단계: OTP 요청 및 확인](#31-1단계-otp-요청-및-확인)
    *   [3.2. 2단계: 회원가입](#32-2단계-회원가입)
4.  [API 엔드포인트](#4-api-엔드포인트)
5.  [데이터베이스 스키마](#5-데이터베이스-스키마)
6.  [이메일 전송 설정 (Thymeleaf 템플릿)](#6-이메일-전송-설정-thymeleaf-템플릿)
7.  [주요 고려사항](#7-주요-고려사항)
8.  [오류 처리](#8-오류-처리)

---

### 1. 개요

**Smarter Store API**의 이메일 인증은 회원가입 과정의 일부로, 사용자가 제공한 **이메일 주소의 유효성** 및 **소유권**을 확인하는 중요한 절차입니다. 2단계 인증 프로세스를 통해 사용자 경험과 보안을 모두 고려합니다.

### 2. 프로세스 참여자

*   **사용자 (User):** 이메일 인증 요청 및 OTP 확인, 최종 회원가입의 주체.
*   **클라이언트 (Client):** API 서버와 상호작용하여 OTP 요청, 확인 및 회원가입을 수행.
*   **API 서버 (API Server):**
    *   OTP 생성, 저장 및 유효성 검사.
    *   **EmailService**를 통한 이메일 발송 및 `EmailVerificationToken` 상태 업데이트.
    *   최종 회원가입 처리.
*   **이메일 서비스 (Email Service):** API 서버의 지시에 따라 사용자에게 OTP 인증 이메일을 발송.
*   **데이터베이스 (Database):** 사용자 정보(`User` 엔티티) 및 이메일 인증 토큰 정보(`EmailVerificationToken` 엔티티)를 저장.

### 3. 프로세스 흐름

이메일 인증 프로세스는 크게 **OTP 요청 및 확인**과 **회원가입** 두 단계로 나뉩니다.

#### 3.1. 1단계: OTP 요청 및 확인

사용자가 이메일 소유권을 증명하는 과정입니다.

1.  **OTP 요청 (클라이언트 -> 서버):**
    *   **엔드포인트:** `POST /api/auth/email-verification/request`
    *   **설명:** 사용자가 가입할 이메일 주소를 입력하고 OTP 발송을 요청합니다.
    *   **서버 처리:**
        *   해당 이메일로 이미 가입된 사용자가 있는지 확인합니다. (있으면 `EMAIL_ALREADY_EXISTS` 오류)
        *   기존에 발송된 미사용 OTP가 있다면 삭제합니다.
        *   **6자리 영숫자 OTP**를 생성하고, 만료 시간(예: 5분)과 함께 `EmailVerificationToken` 엔티티로 데이터베이스에 저장합니다. 이때 `isConfirmed`는 `false`입니다.
        *   `EmailService`를 통해 사용자 이메일로 OTP를 발송합니다.

2.  **OTP 확인 (클라이언트 -> 서버):**
    *   **엔드포인트:** `POST /api/auth/confirm-otp`
    *   **설명:** 사용자가 이메일로 받은 OTP를 입력하여 확인을 요청합니다.
    *   **서버 처리:**
        *   요청된 이메일과 OTP로 `EmailVerificationToken`을 조회합니다. (없으면 `INVALID_EMAIL_VERIFICATION_TOKEN` 오류)
        *   토큰의 만료 여부, 이미 확인된 토큰인지 등을 검증합니다.
        *   검증 통과 시, 해당 토큰의 `isConfirmed` 필드를 `true`로 업데이트하고 데이터베이스에 저장합니다.

#### 3.2. 2단계: 회원가입

OTP 확인이 완료된 이메일로 최종 회원가입을 진행합니다.

1.  **회원가입 요청 (클라이언트 -> 서버):**
    *   **엔드포인트:** `POST /api/auth/signup`
    *   **설명:** 사용자가 이메일, 사용자명, 비밀번호 등 최종 가입 정보를 입력하여 요청합니다.
    *   **서버 처리:**
        *   요청된 이메일로 `isConfirmed`가 `true`인 `EmailVerificationToken`이 있는지 조회합니다. (없으면 `EMAIL_NOT_VERIFIED` 오류)
        *   토큰이 유효하다면, `User` 엔티티를 생성하고 `isEmailVerified`를 `true`로 설정하여 저장합니다.
        *   사용이 완료된 `EmailVerificationToken`은 데이터베이스에서 삭제하여 재사용을 방지합니다.

### 4. API 엔드포인트

*   **OTP 요청:**
    *   `POST /api/auth/email-verification/request`
    *   **요청 바디:** `{ "email": "user@example.com" }`
*   **OTP 확인:**
    *   `POST /api/auth/confirm-otp`
    *   **요청 바디:** `{ "email": "user@example.com", "otp": "A1B2C3" }`
*   **회원가입:**
    *   `POST /api/auth/signup`
    *   **요청 바디:** `{ "email": "user@example.com", "username": "홍길동", "password": "password123" }`

### 5. 데이터베이스 스키마

*   **`User` 엔티티:**
    *   `isEmailVerified`: `Boolean` - 사용자의 이메일 인증 최종 완료 상태.

*   **`EmailVerificationToken` 엔티티:**
    *   **주요 필드:**
        *   `id`: `Long`
        *   `email`: `String` (인증 대상 이메일)
        *   `token`: `String` (6자리 영숫자 OTP)
        *   `expiryDate`: `LocalDateTime` (토큰 만료 시간)
        *   `isConfirmed`: `Boolean` (OTP 확인 완료 여부, 기본값 `false`)

### 6. 이메일 전송 설정 (Thymeleaf 템플릿)

이메일 본문은 유지보수성 향상을 위해 **Thymeleaf** 템플릿 엔진을 사용하여 생성됩니다.

*   **의존성 (`build.gradle.kts`):** `spring-boot-starter-thymeleaf`
*   **템플릿 위치:** `src/main/resources/templates/mail/verification.html`
*   **서비스 로직 (`EmailService.kt`):**
    *   `SpringTemplateEngine`을 주입받아 사용합니다.
    *   `Context` 객체에 OTP(`otp`) 변수를 담아 `templateEngine.process()` 메서드를 호출하여 HTML을 생성하고, 이를 이메일 본문으로 사용합니다.

### 7. 주요 고려사항

*   **OTP 유효 기간:** `EmailVerificationToken`의 만료 시간은 5분으로 짧게 설정되어 있습니다.
*   **OTP 재전송:** 사용자가 OTP 재전송을 요청하면, 기존 OTP 토큰은 삭제되고 새로운 토큰이 생성 및 발송됩니다.
*   **보안:**
    *   OTP는 예측이 어렵도록 영문 대문자와 숫자를 조합하여 생성됩니다.
    *   한 번 OTP 확인에 사용된 토큰은 `isConfirmed` 상태로 변경되며, 최종 회원가입 시 삭제되어 재사용이 불가능합니다.

### 8. 오류 처리

*   `EMAIL_ALREADY_EXISTS`: (`HTTP 409`) 이미 가입된 이메일로 OTP를 요청할 경우.
*   `INVALID_EMAIL_VERIFICATION_TOKEN`: (`HTTP 400`) 제공된 OTP가 유효하지 않거나 존재하지 않을 경우.
*   `EXPIRED_EMAIL_VERIFICATION_TOKEN`: (`HTTP 400`) 제공된 OTP가 만료되었을 경우.
*   `EMAIL_NOT_VERIFIED`: (`HTTP 400`) OTP 확인 절차를 거치지 않고 회원가입을 시도할 경우.
*   `INTERNAL_SERVER_ERROR`: (`HTTP 500`) 이메일 발송 시스템 오류 등 서버 내부 문제.
