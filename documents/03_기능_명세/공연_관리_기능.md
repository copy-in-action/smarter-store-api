# 공연(Performance) 기능 가이드

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2025-12-16 | BE | 초안 작성 |
| 1.1 | 2025-12-17 | BE | Company API 필드명 수정, Performance 필드 추가 |
| 1.2 | 2025-12-18 | Gemini | ERD, 테이블 상세, API 엔드포인트 및 프로젝트 구조를 최신 구현 내용에 맞춰 업데이트. @Tag 이름 통일. |

## 1. 개요

공연 정보(콘서트, 뮤지컬 등)를 관리하는 기능을 설명합니다.
이 문서는 해당 기능의 데이터베이스 구조, API 엔드포인트, 코드 구조를 설명하여 협업 개발자가 기능을 이해하고 사용할 수 있도록 돕는 것을 목적으로 합니다.

---

## 2. 데이터 구조 및 연관 관계

공연 정보를 효율적으로 관리하기 위해 데이터를 여러 테이블로 정규화하여 설계했습니다.

- `venue`: 공연 장소 정보
- `performance`: 공연의 핵심 정보 (부모)
- `performance_schedule`: 공연의 특정 회차(날짜/시간) 정보 (자식)
- `ticket_option`: 공연 회차별 티켓 종류(좌석 등급) 및 가격 정보 (자식)
- `company`: 판매자/기획사 정보

### ERD (텍스트 기반)

```
┌───────────────────┐       ┌───────────────────┐
│       Venue       │───────│ VenueSeatCapacity │
├───────────────────┤  1:N  ├───────────────────┤
│ id                │       │ id                │
│ name              │       │ venue_id (FK)     │
│ address           │       │ seat_grade        │
│ phone_number      │       │ capacity          │
│ seating_chart     │       └───────────────────┘
└───────────────────┘                 
          │                         
          │ 1:N                     
          ▼                         
┌───────────────────┐       ┌───────────────────┐
│    Performance    │───────│     Company       │
├───────────────────┤  N:1  ├───────────────────┤
│ id                │       │ id                │
│ title             │       │ name              │
│ venue_id (FK)     │       │ ...               │
│ company_id (FK)   │       └───────────────────┘
│ ...               │                             
└───────────────────┘                             
          │                                       
          │ 1:N                                   
          ▼                                       
┌───────────────────┐       ┌───────────────────┐
│ PerformanceSchedule │───────│   TicketOption    │
├───────────────────┤  1:N  ├───────────────────┤
│ id                │       │ id                │
│ performance_id (FK) │       │ schedule_id (FK)  │
│ show_datetime     │       │ seat_grade        │
│ sale_start_datetime │       │ price             │
└───────────────────┘       └───────────────────┘
          │                                       
          │ 1:N (논리적 연결)                     
          ▼                                       
┌───────────────────┐                             
│ ScheduleSeatStatus│                             
├───────────────────┤                             
│ id                │                             
│ schedule_id (FK)  │                             
│ row_num           │                             
│ col_num           │                             
│ status            │                             
│ held_until        │                             
│ held_by           │                             
└───────────────────┘                             
```
**주요 변경 사항:**
*   `Seat` 엔티티는 존재하지 않으며, `Venue`의 `seatingChart` 필드(JSON 문자열)에 좌석 배치 정보가 저장됩니다.
*   `ScheduleSeatStatus` 엔티티가 회차별 좌석 상태를 관리하며, `row_num`, `col_num`으로 좌석을 식별합니다.
*   `Reservation` 및 `ReservationSeat` 관련 엔티티는 현재 구현되어 있지 않습니다.
*   `TicketOption`이 `PerformanceSchedule`과 직접 연결됩니다.
### 테이블 상세

#### 2.1. `venue`

공연 장소 정보를 저장합니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 공연장 ID |
| `name` | `VARCHAR(100)` | 공연장 이름 |
| `address` | `VARCHAR(255)` | 주소 |
| `phone_number` | `VARCHAR(50)` | 공연장 대표번호 |
| `seating_chart` | `TEXT` | 좌석 배치도 JSON 문자열 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.2. `performance`

공연의 고유 정보를 저장합니다. `venue` 테이블 및 `company` 테이블과 다대일(N:1) 관계를 가집니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 공연 ID |
| `title` | `VARCHAR(255)`| 공연명 |
| `description` | `TEXT` | 공연 상세 설명 |
| `category` | `VARCHAR(50)` | 카테고리 (e.g., '콘서트') |
| `running_time`| `INT` | 공연 시간 (분) |
| `age_rating` | `VARCHAR(50)` | 관람 연령 |
| `main_image_url` |`VARCHAR(255)`| 대표 이미지 URL |
| `visible` | `BOOLEAN` | 공연 노출 여부 |
| `venue_id` | `BIGINT` | FK, `venue` 테이블 ID |
| `start_date` | `DATE` | 공연 시작일 |
| `end_date` | `DATE` | 공연 종료일 |
| `actors` | `TEXT` | 출연진 |
| `agency` | `VARCHAR(255)` | 기획사 |
| `producer` | `VARCHAR(255)` | 제작사 |
| `host` | `VARCHAR(255)` | 주최 |
| `discount_info` | `TEXT` | 할인정보 |
| `usage_guide` | `TEXT` | 이용안내 |
| `refund_policy` | `TEXT` | 취소/환불규정 |
| `detail_image_url` | `VARCHAR(500)` | 상품상세 이미지 URL |
| `company_id` | `BIGINT` | FK, `company` 테이블 ID |
| `booking_fee` | `INT` | 예매 수수료 |
| `shipping_guide` | `TEXT` | 배송 안내 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.3. `performance_schedule`

`performance`에 종속되는 특정 회차(날짜/시간) 정보를 저장합니다. `performance` 테이블과 다대일(N:1) 관계를 가집니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 스케줄 ID |
| `performance_id`| `BIGINT` | FK, `performance` 테이블 ID |
| `show_datetime` | `TIMESTAMP` | 공연 날짜 및 시간 |
| `sale_start_datetime` | `TIMESTAMP` | 티켓 판매 시작 시각 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.4. `ticket_option`

`performance_schedule`에 종속되는 티켓 종류(e.g., R석, S석)와 가격 정보를 저장합니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 티켓 옵션 ID |
| `performance_schedule_id`| `BIGINT` | FK, `performance_schedule` 테이블 ID |
| `seat_grade` | `VARCHAR(20)`| 좌석 등급 (ENUM: VIP, R, S, A, B) |
| `price` | `INT`| 가격 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

<br/>

#### 2.5. `company`

판매자/기획사 정보를 저장합니다.

| 컬럼명 | 데이터 타입 | 설명 |
|---|---|---|
| `id` | `BIGSERIAL` | PK, 회사 ID |
| `name` | `VARCHAR(255)` | 상호 |
| `ceo_name` | `VARCHAR(100)` | 대표자명 |
| `business_number` | `VARCHAR(50)` | 사업자등록번호 |
| `email` | `VARCHAR(255)` | 이메일 |
| `contact` | `VARCHAR(50)` | 연락처 |
| `address` | `VARCHAR(500)` | 주소 |
| `performance_inquiry` | `VARCHAR(255)` | 공연 문의 연락처/이메일 |
| `created_at` | `TIMESTAMP` | 생성일시 |
| `updated_at` | `TIMESTAMP` | 수정일시 |

---

## 3. API 엔드포인트

### 3.1. 공연장 API (`/api/venues`)

| Method | URL | 권한 | 설명 |
|---|---|---|---|
| `POST` | `/` | ADMIN | 새 공연장 생성 |
| `GET` | `/{id}` | 누구나 | 특정 공연장 정보 조회 |
| `GET` | `/` | 누구나 | 모든 공연장 목록 조회 |
| `PUT` | `/{id}` | ADMIN | 특정 공연장 정보 수정 |
| `DELETE` | `/{id}` | ADMIN | 특정 공연장 삭제 |
| `GET` | `/{id}/seating-chart` | 누구나 | 공연장 좌석 배치도 JSON 조회 |
| `PUT` | `/{id}/seating-chart` | ADMIN | 공연장 좌석 배치도 JSON 저장/수정 |

### 3.2. 공연 API (`/api/performances`)

| Method | URL | 권한 | 설명 | |
|---|---|---|---|---|
| `POST` | `/` | ADMIN | 새 공연 생성 |
| `GET` | `/{id}` | 누구나 | 특정 공연 정보 조회 |
| `GET` | `/` | 누구나 | 모든 공연 목록 조회 |
| `PUT` | `/{id}` | ADMIN | 특정 공연 정보 수정 |
| `DELETE`| `/{id}` | ADMIN | 특정 공연 삭제 |

### 3.3. 공연 회차 API (`/api/admin/performances/{performanceId}/schedules` 또는 `/api/admin/schedules/{scheduleId}`)

| Method | URL | 권한 | 설명 |
|---|---|---|---|
| `POST` | `/{performanceId}/schedules` | ADMIN | 특정 공연에 대한 새 회차 생성 |
| `GET` | `/schedules/{scheduleId}` | ADMIN | ID로 특정 공연 회차 정보 조회 |
| `GET` | `/{performanceId}/schedules` | ADMIN | 특정 공연의 모든 회차 목록 조회 |
| `PUT` | `/schedules/{scheduleId}` | ADMIN | 특정 공연 회차 정보 수정 |
| `DELETE`| `/schedules/{scheduleId}` | ADMIN | 특정 공연 회차 삭제 |

### 3.4. 기획사/판매자 API (`/api/companies`)

| Method | URL | 권한 | 설명 |
|---|---|---|---|
| `POST` | `/` | ADMIN | 새 기획사/판매자 정보 생성 |
| `GET` | `/{id}` | 누구나 | 특정 기획사/판매자 정보 조회 |
| `GET` | `/` | 누구나 | 모든 기획사/판매자 목록 조회 |
| `PUT` | `/{id}` | ADMIN | 특정 기획사/판매자 정보 수정 |
| `DELETE`| `/{id}` | ADMIN | 특정 기획사/판매자 삭제 |

---

## 4. 프로젝트 구조

공연 기능과 관련된 주요 파일 및 패키지 구조는 다음과 같습니다. 기존 프로젝트의 도메인 주도 설계(DDD) 및 패키징 컨벤션을 따릅니다.

```
src/main/kotlin/com/github/copyinaction/
├── common/
│   ├── exception/
│   │   └── ErrorCode.kt  # 공통 에러 코드 (공연 관련 에러 코드 포함)
│   └── domain/
│       └── BaseEntity.kt # 공통 엔티티 속성
├── config/
│   ├── SecurityConfig.kt # 보안 설정 (공연 관련 엔드포인트 접근 권한 설정 포함)
│   └── jwt/              # JWT 관련 설정
├── performance/
│   ├── controller/
│   │   ├── CompanyController.kt          # 기획사/판매자 관련 API
│   │   ├── PerformanceController.kt      # 공연 관련 API
│   │   └── PerformanceScheduleController.kt # 공연 회차 관련 API
│   ├── domain/
│   │   ├── Company.kt                    # 기획사/판매자 엔티티
│   │   ├── Performance.kt                # 공연 엔티티
│   │   ├── PerformanceSchedule.kt        # 공연 회차 엔티티
│   │   └── TicketOption.kt               # 공연 회차별 티켓 옵션 엔티티
│   ├── dto/
│   │   ├── CompanyDto.kt                 # 기획사/판매자 DTO
│   │   ├── PerformanceDto.kt             # 공연 DTO
│   │   ├── PerformanceScheduleDto.kt     # 공연 회차 DTO
│   │   └── TicketOptionDto.kt            # 티켓 옵션 DTO
│   ├── repository/
│   │   ├── CompanyRepository.kt          # 기획사/판매자 레포지토리
│   │   ├── PerformanceRepository.kt      # 공연 레포지토리
│   │   ├── PerformanceScheduleRepository.kt # 공연 회차 레포지토리
│   │   └── TicketOptionRepository.kt     # 티켓 옵션 레포지토리
│   └── service/
│       ├── CompanyService.kt             # 기획사/판매자 비즈니스 로직
│       ├── PerformanceService.kt         # 공연 비즈니스 로직
│       └── PerformanceScheduleService.kt # 공연 회차 비즈니스 로직
└── venue/
    ├── controller/
    │   └── VenueController.kt            # 공연장 관련 API
    ├── domain/
    │   ├── Venue.kt                      # 공연장 엔티티
    │   ├── SeatGrade.kt                  # 좌석 등급 Enum
    │   └── VenueSeatCapacity.kt          # 공연장 등급별 좌석 용량 엔티티
    ├── dto/
    │   ├── VenueDto.kt                   # 공연장 DTO
    │   └── VenueSeatCapacityDto.kt       # 공연장 등급별 좌석 용량 DTO
    ├── repository/
    │   ├── VenueRepository.kt            # 공연장 레포지토리
    │   └── VenueSeatCapacityRepository.kt # 공연장 등급별 좌석 용량 레포지토리
    └── service/
        └── VenueService.kt               # 공연장 비즈니스 로직
```

---```
