# 사이트맵 시스템 설계 및 연동 가이드

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0  | 2026-01-07 | Gemini | 사이트맵 데이터 제공 및 Revalidation 연동 설계 작성 |

이 문서는 `smarter-store-api`에서 프론트엔드(Next.js)의 사이트맵 생성을 지원하기 위한 API 및 실시간 갱신 로직에 대해 정의합니다.

## 1. 개요
프론트엔드 검색 엔진 최적화(SEO)를 위해 동적으로 변하는 공연 상세 페이지의 정보를 사이트맵에 실시간으로 반영합니다.

## 2. 사이트맵 데이터 제공 API

프론트엔드 빌드 타임 또는 요청 타임에 공연 목록 데이터를 제공합니다.

### API 명세
- **Endpoint**: `GET /api/performances/sitemap`
- **Description**: 공개 상태(`visible: true`)인 모든 공연의 ID와 마지막 수정 시각을 반환합니다.
- **Response**:
```json
[
  {
    "id": 1,
    "lastModifiedAt": "2026-01-07T12:00:00"
  },
  {
    "id": 2,
    "lastModifiedAt": "2026-01-07T14:30:00"
  }
]
```

### 구현 최적화
- 데이터베이스 부하를 줄이기 위해 `Performance` 엔티티 전체가 아닌 `id`와 `updatedAt` 필드만 프로젝션하여 조회합니다.

## 3. 실시간 사이트맵 갱신 (Revalidation)

프론트엔드(Next.js)는 성능 최적화를 위해 페이지 및 사이트맵을 캐싱(ISR, Static Generation 등)하고 있습니다. 따라서 데이터 변경 시 백엔드에서 능동적으로 캐시 갱신을 요청해야 합니다.

### 필요성 (Why?)
- **캐시 문제 해결**: Next.js가 설정한 시간(`revalidate` 주기)이 지나기 전까지는 DB에 데이터가 추가되어도 사용자는 이전 사이트맵/페이지를 보게 됩니다.
- **즉시성 확보**: 관리자가 공연을 등록/수정하는 즉시 검색 엔진과 사용자에게 최신 정보를 제공하기 위해 백엔드 트리거가 필수적입니다.

### 연동 워크플로우
1. 관리자가 공연을 등록하거나 수정합니다.
2. 백엔드는 DB 트랜잭션 성공 후 프론트엔드의 Revalidation Endpoint로 HTTP 요청을 보냅니다.
3. 프론트엔드는 해당 요청을 받고 지정된 태그(`tag`) 또는 경로(`path`)의 캐시를 무효화(Purge)하여 데이터를 다시 생성합니다.

### 프론트엔드 엔드포인트 예시
- **URL**: `https://ticket.devhong.cc/api/revalidate?secret={REVALIDATE_TOKEN}&tag=performance-sitemap`
- **Method**: `GET` 또는 `POST`

## 4. 보안 설정 (Token Verification)

백엔드와 프론트엔드 간의 통신 보안을 위해 공유 비밀키(Shared Secret) 방식을 사용합니다.

- **토큰 명칭**: `REVALIDATE_TOKEN`
- **검증 원리**:
    1. **백엔드**: 요청 시 URL 파라미터(`secret`)에 토큰을 포함하여 전송합니다.
    2. **프론트엔드**: 서버 환경 변수에 저장된 토큰과 백엔드가 보낸 토큰을 비교합니다.
    3. **결과**: 두 값이 일치하는 경우에만 캐시 갱신 작업을 수행하여 외부인의 악의적인 캐시 무효화 공격을 방지합니다.

## 5. 프론트엔드 (Next.js) 구현 가이드

백엔드의 변경 사항을 반영하기 위해 프론트엔드에서 다음 작업이 필요합니다.

### 5.1 환경 변수 설정
프론트엔드 프로젝트의 `.env.local` 또는 배포 환경 설정에 백엔드와 동일한 토큰을 설정합니다.
```bash
REVALIDATE_TOKEN=your-secret-token-value
```

### 5.2 Revalidation API Route 구현
백엔드로부터 갱신 요청을 받을 API Route를 구현하며, 반드시 전달받은 토큰(`secret`)을 검증해야 합니다.

**파일 경로**: `app/api/revalidate/route.ts` (App Router 기준)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { revalidateTag } from 'next/cache';

export async function GET(request: NextRequest) {
  // 백엔드가 URL 파라미터로 보낸 토큰(?secret=...)을 추출
  const secret = request.nextUrl.searchParams.get('secret');
  const tag = request.nextUrl.searchParams.get('tag');

  // 1. 보안 토큰 검증 (프론트 환경 변수와 대조)
  if (secret !== process.env.REVALIDATE_TOKEN) {
    console.error('Unauthorized revalidation attempt');
    return NextResponse.json({ message: 'Invalid token' }, { status: 401 });
  }

  // 2. 태그 유효성 확인
  if (!tag) {
    return NextResponse.json({ message: 'Missing tag param' }, { status: 400 });
  }

  // 3. 캐시 무효화 실행 (On-Demand Revalidation)
  try {
    revalidateTag(tag);
    return NextResponse.json({ revalidated: true, now: Date.now() });
  } catch (err) {
    return NextResponse.json({ message: 'Error revalidating' }, { status: 500 });
  }
}
```

### 5.2 사이트맵 생성 로직 수정
`performance/sitemap/0.xml` 생성 시 백엔드의 신규 API(`/api/performances/sitemap`)를 호출하도록 수정합니다.

```typescript
// fetch 호출 시 캐시 태그 설정 필수
const response = await fetch(`${API_URL}/api/performances/sitemap`, {
  next: { tags: ['performance-sitemap'] } 
});
```

## 6. 테스트 방법

### 6.1 백엔드 API 테스트
Swagger UI 또는 Curl을 사용하여 사이트맵 데이터가 정상적으로 반환되는지 확인합니다.
```bash
curl -X GET "http://localhost:8080/api/performances/sitemap"
```

### 6.2 Revalidation 연동 테스트
1. **로그 확인**: 백엔드 로그(`FrontendRevalidationService`)를 모니터링합니다. (`grep "Triggering frontend revalidation"`)
2. **공연 수정**: 관리자 API를 통해 공연 정보를 수정합니다.
3. **로그 확인**: 백엔드가 프론트엔드 API를 호출했는지 로그로 확인합니다. (로컬 테스트 시 실패 로그가 찍힐 수 있음 - URL 연결 불가 등)
4. **프론트엔드 확인**: 프론트엔드 서버 로그에서 `/api/revalidate` 호출 여부를 확인합니다.

