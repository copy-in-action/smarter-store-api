# 쿠폰 적용 가이드

## 개정이력
| 버전 | 일자 | 작성자 | 내용 |
|------|------|--------|------|
| 1.0 | 2026-01-08 | Claude | 최초 작성 |
| 1.1 | 2026-01-08 | Claude | couponIds 제거, seatCoupons만 사용하도록 단순화 |

---

## 1. 개요

이 문서는 쿠폰 시스템 API의 사용 방법을 설명합니다. 특히 **예매 시작 → 쿠폰 선택 → 쿠폰 검증 → 결제** 전체 플로우를 중심으로 설명합니다.

### 핵심 개념

- **BookingSeat**: 예매 시 생성되는 개별 좌석 엔티티 (각 좌석마다 고유 ID 부여)
- **BookingSeatId**: 쿠폰 검증 시 좌석을 식별하기 위한 ID (`/api/bookings/start` 응답에서 제공)
- **좌석별 쿠폰 적용**: 각 좌석마다 다른 쿠폰을 적용 가능

---

## 2. API 엔드포인트

### 2.1 사용 가능한 쿠폰 목록 조회

```http
GET /api/coupons
Authorization: Bearer {accessToken}
```

**응답 예시:**
```json
[
  {
    "id": 101,
    "name": "신년 맞이 할인 쿠폰",
    "discountRate": 10,
    "validUntil": "2025-12-31T23:59:59"
  },
  {
    "id": 102,
    "name": "VIP 회원 쿠폰",
    "discountRate": 20,
    "validUntil": "2025-06-30T23:59:59"
  }
]
```

### 2.2 쿠폰 검증

```http
POST /api/coupons/validate
Authorization: Bearer {accessToken}
Content-Type: application/json
```

**요청 바디:**
```json
{
  "bookingId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "seatCoupons": [
    {
      "bookingSeatId": 1,
      "couponId": 101,
      "originalPrice": 50000
    },
    {
      "bookingSeatId": 2,
      "couponId": 102,
      "originalPrice": 50000
    }
  ]
}
```

**응답 예시:**
```json
{
  "results": [
    {
      "bookingSeatId": 1,
      "couponId": 101,
      "originalPrice": 50000,
      "discountAmount": 5000,
      "finalPrice": 45000,
      "isValid": true,
      "message": null
    },
    {
      "bookingSeatId": 2,
      "couponId": 102,
      "originalPrice": 50000,
      "discountAmount": 10000,
      "finalPrice": 40000,
      "isValid": true,
      "message": null
    }
  ],
  "totalOriginalPrice": 100000,
  "totalDiscountAmount": 15000,
  "totalFinalPrice": 85000,
  "allValid": true
}
```

---

## 3. 전체 플로우

### 3.1 플로우 다이어그램

```
┌─────────────────┐
│  1. 좌석 선택    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  2. POST /api/bookings/start        │
│                                     │
│  요청: {scheduleId, seats}          │
│  응답: {bookingId, seats[].id, ...} │ ◄─── ✅ bookingSeatId는 여기서 제공!
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────┐
│  3. 쿠폰 선택    │ ◄─── 사용자가 좌석별로 쿠폰 선택
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  4. POST /api/coupons/validate      │
│                                     │
│  요청: {bookingId, seatCoupons}     │ ◄─── bookingSeatId 사용
│  응답: {results, allValid, ...}     │
└────────┬────────────────────────────┘
         │
         ├─── allValid = false ──► 에러 메시지 표시
         │
         └─── allValid = true ───► 5. 결제 페이지 이동
```

### 3.2 단계별 설명

#### Step 1: 좌석 선택
사용자가 공연 상세 페이지에서 원하는 좌석을 선택합니다.

#### Step 2: 예매 시작 (좌석 점유)

**API 호출:**
```http
POST /api/bookings/start
```

**요청:**
```json
{
  "scheduleId": "schedule-uuid",
  "seats": [
    {"section": "A", "row": 10, "col": 5},
    {"section": "A", "row": 10, "col": 6}
  ]
}
```

**응답:**
```json
{
  "bookingId": "booking-uuid",
  "bookingNumber": "20250108-ABCD1234",
  "expiresAt": "2025-01-08T15:35:00",
  "remainingSeconds": 300,
  "seats": [
    {
      "id": 1,              // ✅ bookingSeatId
      "section": "A",
      "row": 10,
      "col": 5
    },
    {
      "id": 2,              // ✅ bookingSeatId
      "section": "A",
      "row": 10,
      "col": 6
    }
  ],
  "totalPrice": 100000,
  "status": "PENDING"
}
```

**⚠️ 중요:** `seats[].id`를 반드시 저장해야 합니다. 이 값이 쿠폰 검증 시 사용되는 `bookingSeatId`입니다.

#### Step 3: 쿠폰 선택
사용자가 각 좌석별로 적용할 쿠폰을 선택합니다.

#### Step 4: 쿠폰 검증
사용자가 "결제하기" 버튼을 클릭하면 쿠폰 검증 API를 호출합니다.

**API 호출:**
```http
POST /api/coupons/validate
```

**요청:**
```json
{
  "bookingId": "booking-uuid",
  "seatCoupons": [
    {
      "bookingSeatId": 1,    // Step 2에서 받은 seats[0].id
      "couponId": 101,
      "originalPrice": 50000
    },
    {
      "bookingSeatId": 2,    // Step 2에서 받은 seats[1].id
      "couponId": 102,
      "originalPrice": 50000
    }
  ]
}
```

**검증 성공 응답:**
```json
{
  "allValid": true,
  "totalFinalPrice": 85000,
  ...
}
```

**검증 실패 응답:**
```json
{
  "results": [
    {
      "bookingSeatId": 1,
      "isValid": false,
      "message": "쿠폰이 만료되었습니다."
    }
  ],
  "allValid": false,
  ...
}
```

#### Step 5: 결제 페이지 이동
- `allValid === true`: 결제 페이지로 이동
- `allValid === false`: 에러 메시지 표시 후 쿠폰 재선택

---

## 4. bookingSeatId 전달 방법

### 4.1 문제 상황
프론트엔드에서 쿠폰 검증 API 호출 시 `bookingSeatId`를 어디서 가져와야 하는지 불명확할 수 있습니다.

### 4.2 해결 방법
✅ **`/api/bookings/start` 응답의 `seats[].id`가 바로 `bookingSeatId`입니다.**

```typescript
// 예매 시작 응답
const bookingResponse = await api.post('/api/bookings/start', {...});

// seats 배열에 이미 bookingSeatId가 포함되어 있음
console.log(bookingResponse.seats);
// [
//   { id: 1, section: "A", row: 10, col: 5 },  // id가 bookingSeatId
//   { id: 2, section: "A", row: 10, col: 6 }
// ]
```

### 4.3 데이터 매핑 예시

```typescript
// 1. 예매 시작 응답 저장
const [bookingSeats, setBookingSeats] = useState([]);

const startBooking = async () => {
  const response = await api.post('/api/bookings/start', {...});
  setBookingSeats(response.seats); // ✅ seats 배열 저장
};

// 2. 쿠폰 검증 시 bookingSeatId 사용
const validateCoupons = async (selectedCoupons) => {
  const request = {
    bookingId: bookingId,
    seatCoupons: bookingSeats.map((seat, index) => ({
      bookingSeatId: seat.id,          // ✅ 저장된 seat.id 사용
      couponId: selectedCoupons[index],
      originalPrice: seat.price
    }))
  };

  await api.post('/api/coupons/validate', request);
};
```

---

## 5. 쿠폰 적용 방식

쿠폰 검증 요청 시 `seatCoupons` 배열을 사용하여 좌석별로 쿠폰을 매핑합니다.

**사용 방법:**
- 각 좌석마다 적용할 쿠폰을 명시적으로 지정
- 쿠폰을 적용하지 않는 좌석은 배열에 포함하지 않음

**장점:**
- 명확한 좌석-쿠폰 매핑
- 좌석별로 다른 쿠폰 적용 가능
- 원가 정보 포함으로 정확한 검증
- 디버깅 용이

**예시:**
```json
{
  "bookingId": "uuid",
  "seatCoupons": [
    {"bookingSeatId": 1, "couponId": 101, "originalPrice": 50000},
    {"bookingSeatId": 2, "couponId": 102, "originalPrice": 50000}
  ]
}
```

---

## 6. 프론트엔드 구현 예시 (React + TypeScript)

### 6.1 타입 정의

```typescript
// types/booking.ts
interface BookingSeat {
  id: number;          // bookingSeatId
  section: string;
  row: number;
  col: number;
}

interface BookingResponse {
  bookingId: string;
  bookingNumber: string;
  seats: BookingSeat[];
  totalPrice: number;
  expiresAt: string;
  remainingSeconds: number;
}

// types/coupon.ts
interface AvailableCoupon {
  id: number;
  name: string;
  discountRate: number;
  validUntil: string;
}

interface SeatCouponRequest {
  bookingSeatId: number;
  couponId: number;
  originalPrice: number;
}

interface CouponValidateRequest {
  bookingId: string;
  seatCoupons: SeatCouponRequest[];
}

interface SeatCouponResult {
  bookingSeatId: number;
  couponId: number;
  originalPrice: number;
  discountAmount: number;
  finalPrice: number;
  isValid: boolean;
  message?: string;
}

interface CouponValidateResponse {
  results: SeatCouponResult[];
  totalOriginalPrice: number;
  totalDiscountAmount: number;
  totalFinalPrice: number;
  allValid: boolean;
}
```

### 6.2 전체 플로우 구현

```typescript
// BookingFlow.tsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';

const BookingFlow = () => {
  const navigate = useNavigate();

  // 상태 관리
  const [bookingId, setBookingId] = useState<string>('');
  const [bookingSeats, setBookingSeats] = useState<BookingSeat[]>([]);
  const [selectedCoupons, setSelectedCoupons] = useState<Record<number, number>>({});
  const [availableCoupons, setAvailableCoupons] = useState<AvailableCoupon[]>([]);

  // 1. 예매 시작
  const handleStartBooking = async (scheduleId: string, selectedSeats: any[]) => {
    try {
      const response: BookingResponse = await api.post('/api/bookings/start', {
        scheduleId,
        seats: selectedSeats
      });

      // ✅ bookingSeatId가 포함된 seats 배열 저장
      setBookingId(response.bookingId);
      setBookingSeats(response.seats);

      // 사용 가능한 쿠폰 목록 조회
      const coupons = await api.get('/api/coupons');
      setAvailableCoupons(coupons);

      // 쿠폰 선택 페이지로 이동
      navigate('/coupon-selection');
    } catch (error) {
      console.error('예매 시작 실패:', error);
    }
  };

  // 2. 좌석별 쿠폰 선택
  const handleSelectCoupon = (bookingSeatId: number, couponId: number) => {
    setSelectedCoupons(prev => ({
      ...prev,
      [bookingSeatId]: couponId
    }));
  };

  // 3. 쿠폰 검증 및 결제 진행
  const handleProceedToPayment = async () => {
    try {
      // seatCoupons 배열 생성 (쿠폰 선택한 좌석만 포함)
      const seatCoupons: SeatCouponRequest[] = bookingSeats
        .filter(seat => selectedCoupons[seat.id])  // 쿠폰 선택한 좌석만 필터링
        .map(seat => ({
          bookingSeatId: seat.id,  // ✅ 예매 시작에서 받은 seat.id 사용
          couponId: selectedCoupons[seat.id],
          originalPrice: getSeatPrice(seat)  // 좌석 등급별 원가
        }));

      // 쿠폰 검증 API 호출
      const validation: CouponValidateResponse = await api.post('/api/coupons/validate', {
        bookingId,
        seatCoupons
      });

      // 검증 결과 확인
      if (validation.allValid) {
        // ✅ 모든 쿠폰 유효 - 결제 페이지로 이동
        navigate('/payment', {
          state: {
            bookingId,
            totalFinalPrice: validation.totalFinalPrice,
            discountAmount: validation.totalDiscountAmount
          }
        });
      } else {
        // ❌ 검증 실패 - 에러 메시지 표시
        const errors = validation.results
          .filter(r => !r.isValid)
          .map(r => `좌석 ${r.bookingSeatId}: ${r.message}`)
          .join('\n');

        alert(`쿠폰 검증 실패:\n${errors}`);
      }
    } catch (error) {
      console.error('쿠폰 검증 실패:', error);
    }
  };

  // 좌석 등급별 원가 조회 (예시)
  const getSeatPrice = (seat: BookingSeat): number => {
    const priceMap: Record<string, number> = {
      'VIP': 100000,
      'R': 70000,
      'S': 50000,
      'A': 30000
    };
    return priceMap[seat.section] || 30000;
  };

  return (
    <div>
      {/* UI 구현 */}
    </div>
  );
};
```

### 6.3 쿠폰 선택 UI 예시

```typescript
// CouponSelectionPage.tsx
const CouponSelectionPage = () => {
  const { bookingSeats, availableCoupons, selectedCoupons, onSelectCoupon } = useBookingContext();

  return (
    <div>
      <h2>쿠폰 선택</h2>

      {bookingSeats.map(seat => (
        <div key={seat.id} className="seat-coupon-selector">
          <h3>좌석: {seat.section}구역 {seat.row}열 {seat.col}번</h3>

          <select
            value={selectedCoupons[seat.id] || ''}
            onChange={(e) => onSelectCoupon(seat.id, Number(e.target.value))}
          >
            <option value="">쿠폰 선택 안함</option>
            {availableCoupons.map(coupon => (
              <option key={coupon.id} value={coupon.id}>
                {coupon.name} ({coupon.discountRate}% 할인)
              </option>
            ))}
          </select>
        </div>
      ))}

      <button onClick={handleProceedToPayment}>
        결제하기
      </button>
    </div>
  );
};
```

---

## 7. 에러 처리

### 7.1 일반적인 에러 케이스

| HTTP 상태 코드 | 에러 상황 | 처리 방법 |
|--------------|---------|---------|
| 400 | 잘못된 요청 (필수 필드 누락 등) | 요청 데이터 검증 |
| 401 | 인증 실패 | 로그인 페이지로 리다이렉트 |
| 404 | 예매 또는 쿠폰을 찾을 수 없음 | 에러 메시지 표시, 처음부터 재시도 |
| 409 | 쿠폰 사용 횟수 초과 | 다른 쿠폰 선택 유도 |

### 7.2 검증 실패 처리

`allValid === false`인 경우, `results` 배열에서 실패한 좌석을 확인할 수 있습니다.

```typescript
const handleValidationError = (response: CouponValidateResponse) => {
  const failedResults = response.results.filter(r => !r.isValid);

  failedResults.forEach(result => {
    const seat = bookingSeats.find(s => s.id === result.bookingSeatId);
    console.error(`좌석 ${seat?.section}${seat?.row}-${seat?.col}: ${result.message}`);
  });

  // UI에 에러 표시
  showToast('일부 쿠폰을 적용할 수 없습니다. 다른 쿠폰을 선택해주세요.');
};
```

---

## 8. 자주 묻는 질문 (FAQ)

### Q1. bookingSeatId를 프론트엔드에서 어떻게 알 수 있나요?
**A:** `/api/bookings/start` 응답의 `seats[].id`가 바로 `bookingSeatId`입니다. 이 값을 저장했다가 쿠폰 검증 시 사용하면 됩니다.

### Q2. 쿠폰을 선택하지 않은 좌석은 어떻게 처리하나요?
**A:** 쿠폰을 선택하지 않은 좌석은 `seatCoupons` 배열에 포함하지 않으면 됩니다. 해당 좌석은 원가 그대로 적용됩니다.

### Q3. 쿠폰 검증은 언제 호출해야 하나요?
**A:** 사용자가 쿠폰 선택을 완료하고 "결제하기" 버튼을 클릭했을 때 호출합니다. 결제 페이지로 이동하기 직전에 검증해야 합니다.

### Q4. 검증 실패 시 어떻게 처리해야 하나요?
**A:** `allValid === false`인 경우, 사용자에게 에러 메시지를 표시하고 쿠폰을 다시 선택하도록 유도합니다.

### Q5. 한 좌석에 여러 쿠폰을 중복 적용할 수 있나요?
**A:** 현재는 한 좌석당 하나의 쿠폰만 적용 가능합니다. 여러 쿠폰을 적용하려면 가장 할인율이 높은 쿠폰을 선택하세요.

---

## 9. 테스트 시나리오

### 9.1 정상 플로우 테스트

```
1. 사용 가능한 쿠폰 조회
   GET /api/coupons
   → 200 OK, 쿠폰 목록 반환

2. 예매 시작
   POST /api/bookings/start
   → 200 OK, bookingId 및 seats[].id 반환

3. 쿠폰 검증 (모든 쿠폰 유효)
   POST /api/coupons/validate
   → 200 OK, allValid: true

4. 결제 페이지로 이동
```

### 9.2 쿠폰 만료 테스트

```
1. 만료된 쿠폰으로 검증 시도
   POST /api/coupons/validate
   → 200 OK, allValid: false, message: "쿠폰이 만료되었습니다."

2. 다른 쿠폰으로 재검증
   POST /api/coupons/validate
   → 200 OK, allValid: true
```

### 9.3 쿠폰 미선택 테스트

```
1. 일부 좌석만 쿠폰 선택
   seatCoupons: [
     {bookingSeatId: 1, couponId: 101, originalPrice: 50000}
     // bookingSeatId: 2는 쿠폰 미선택으로 배열에 포함하지 않음
   ]

2. 검증 결과
   results: [
     {bookingSeatId: 1, discountAmount: 5000, finalPrice: 45000}
   ]
   totalOriginalPrice: 50000
   totalDiscountAmount: 5000
   totalFinalPrice: 45000

   // 쿠폰을 적용하지 않은 좌석 2번은 예매 시 totalPrice에 포함되어 있음
```

---

## 10. 참고 자료

- **API 명세**: Swagger UI (`/swagger-ui/index.html`)
- **관련 도메인 모델**:
  - `Booking`: 예매 엔티티
  - `BookingSeat`: 예매된 개별 좌석
  - `Coupon`: 쿠폰 엔티티
  - `UserCoupon`: 사용자별 쿠폰 사용 이력
- **소스 코드**:
  - `CouponController.kt`: 쿠폰 API 컨트롤러
  - `BookingController.kt`: 예매 API 컨트롤러
  - `CouponService.kt`: 쿠폰 비즈니스 로직
