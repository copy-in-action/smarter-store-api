# 공연/좌석 등록 플로우 가이드

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2025-12-10 | BE | 초안 작성 |
| 1.1 | 2025-12-17 | BE | Company API 필드명 수정, 좌석 관련 단계(2, 6단계) 설계 중 표시 추가, 데이터 관계도 수정 |
| 1.2 | 2025-12-18 | Gemini | JSON 기반 좌석 시스템 구현 내용을 반영하여 전체 등록 흐름, 단계별 상세 설명, FE 협의 필요 부분 업데이트. PerformanceSchedule CRUD API 반영. |
| 1.3 | 2025-12-18 | BE | 좌석 배치도 저장 API 통합 (seatingChart + seatCapacities 동시 저장) |
| 1.4 | 2025-12-18 | BE | seatingChart 타입을 String에서 JSON Object로 변경 (프론트 편의성 개선) |
| 1.5 | 2025-12-18 | BE | 등급별 좌석수 별도 CRUD API 제거 (배치도 저장 API에 통합) |

---

## 개요

이 문서는 관리자가 공연을 등록하고 예매를 오픈하기까지의 전체 흐름을 설명합니다.
프론트엔드 개발자와 협의하여 최적의 UI/UX를 설계하기 위한 참고 자료입니다.

---

## 전체 등록 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│  1. 공연장(Venue) 등록                                               │
│     - 공연장 이름, 주소, 대표번호                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. 좌석 배치도 + 등급별 좌석수 등록 (통합 API)                       │
│     - 좌석 배치도 JSON (layoutJson)                                  │
│     - 등급별 좌석 수 (seatCapacities)                                │
│     ※ 한 번의 API 호출로 동시 저장                                    │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. 기획사(Company) 등록                                             │
│     - 기획사명, 대표자명, 사업자번호 등 기본 정보                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. 공연(Performance) 등록                                           │
│     - 공연 정보 (제목, 설명, 카테고리, 출연진, 기획사 등 상세 정보)   │
│     - 공연장 선택 (venueId)                                          │
│     - 기획사 선택 (companyId)                                        │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. 공연 회차(Schedule) 등록                                         │
│     - 공연 일시, 판매 시작 일시                                       │
│     - 회차별 티켓 옵션 (좌석등급별 가격) 등록                           │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. 회차별 좌석 상태 관리 (자동 생성 및 변경)                        │
│     - 좌석 점유 시점에 `ScheduleSeatStatus` 엔티티 자동 생성         │
│     - 상태: PENDING (점유), RESERVED (예매 완료)                       │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  7. 공연 노출 (visible = true)                                       │
│     - 사용자에게 공연 공개                                            │
│     - 예매 시작                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 단계별 상세 설명

### 1단계: 공연장 등록

공연이 진행될 장소를 등록합니다.

```http
POST /api/admin/venues
Content-Type: application/json
{
  "name": "올림픽공원 올림픽홀",
  "address": "서울시 송파구 올림픽로 424",
  "phoneNumber": "02-1234-5678"
}
```

---

### 2단계: 좌석 배치도 + 등급별 좌석수 등록 (통합 API)

공연장의 좌석 배치도 JSON과 등급별 좌석 수를 **한 번의 API 호출로 동시에 저장**합니다.

```http
PUT /api/admin/venues/{venueId}/seating-chart
Content-Type: application/json
{
  "seatingChart": {
    "sections": [
      {
        "name": "1층",
        "rows": [
          {
            "name": "A",
            "seats": [
              { "number": 1, "seatGrade": "VIP", "x": 10, "y": 10 },
              { "number": 2, "seatGrade": "VIP", "x": 30, "y": 10 }
            ]
          }
        ]
      }
    ]
  },
  "seatCapacities": [
    { "seatGrade": "VIP", "capacity": 100 },
    { "seatGrade": "R", "capacity": 200 },
    { "seatGrade": "S", "capacity": 300 }
  ]
}
```

#### 응답
```json
{
  "venueId": 1,
  "seatingChart": {
    "sections": [...]
  },
  "seatCapacities": [
    { "id": 1, "venueId": 1, "seatGrade": "VIP", "capacity": 100 },
    { "id": 2, "venueId": 1, "seatGrade": "R", "capacity": 200 },
    { "id": 3, "venueId": 1, "seatGrade": "S", "capacity": 300 }
  ]
}
```

#### 동작 방식
- `seatingChart`는 **JSON 객체**로 전달 (이스케이프 불필요, 프론트에서 그대로 전송)
- `seatCapacities`가 전달되면 기존 좌석 용량을 **삭제 후 새로 저장** (일괄 교체)
- `seatCapacities`가 `null`이면 배치도만 저장 (기존 좌석 용량 유지)
- 단일 트랜잭션으로 처리되어 데이터 정합성 보장
- DB에는 JSON 문자열로 저장되지만, API 요청/응답은 JSON 객체로 처리

---

### 3단계: 기획사 (Company) 등록

공연과 관련된 기획사/판매자 정보를 등록합니다.

```http
POST /api/admin/companies
Content-Type: application/json
{
  "name": "카피인액션",
  "ceoName": "홍길동",
  "businessNumber": "123-45-67890",
  "email": "hello@example.com",
  "contact": "02-9876-5432",
  "address": "서울시 강남구...",
  "performanceInquiry": "concert@example.com"
}
```

---

### 4단계: 공연 등록

공연 정보와 함께 관련 공연장 및 기획사 정보를 연결합니다.

```http
POST /api/admin/performances
Content-Type: application/json
{
  "title": "2025 HYOLYN CONCERT",
  "description": "효린 단독 콘서트",
  "category": "CONCERT",
  "runningTime": 120,
  "ageRating": "전체 관람가",
  "venueId": 1,
  "companyId": 1,
  "actors": "효린, 댄서팀",
  "agency": "스타쉽 엔터테인먼트",
  "producer": "콘서트 기획팀",
  "host": "주최사",
  "discountInfo": "조기 예매 10% 할인",
  "usageGuide": "공연 30분 전부터 입장 가능",
  "refundPolicy": "구매 후 7일까지 취소 가능",
  "detailImageUrl": "http://example.com/detail_image.jpg",
  "startDate": "2025-12-25",
  "endDate": "2025-12-26"
}
```

---

### 5단계: 공연 회차 등록

공연 일시, 판매 시작 일시와 함께 해당 회차에 대한 티켓 가격 정책을 설정합니다. `TicketOption`은 `PerformanceSchedule`에 직접 연결됩니다.

```http
POST /api/admin/performances/{performanceId}/schedules
Content-Type: application/json
{
  "showDateTime": "2025-12-25T14:00:00",
  "saleStartDateTime": "2025-12-01T10:00:00",
  "ticketOptions": [ // 회차별 티켓 옵션
    {
      "seatGrade": "VIP",    // 좌석 등급 (VenueSeatCapacity 등급과 일치)
      "price": 150000        // 해당 등급의 티켓 가격
    },
    {
      "seatGrade": "R",
      "price": 120000
    },
    {
      "seatGrade": "S",
      "price": 90000
    }
  ]
}
```

#### 회차 관리 API (CRUD)

공연 회차는 다음 API를 통해 조회, 수정, 삭제가 가능합니다.

*   **단일 회차 조회:** `GET /api/admin/schedules/{scheduleId}`
*   **특정 공연의 모든 회차 조회:** `GET /api/admin/performances/{performanceId}/schedules`
*   **회차 정보 수정:** `PUT /api/admin/schedules/{scheduleId}`
*   **회차 삭제:** `DELETE /api/admin/schedules/{scheduleId}`

---

### 6단계: 회차별 좌석 상태 관리

개별 좌석의 `ScheduleSeatStatus`는 사용자가 좌석을 점유할 때(`POST /api/schedules/{scheduleId}/seats/hold`) 자동으로 생성되며, 이후 예약 확정(`POST /api/schedules/{scheduleId}/seats/reserve`) 또는 점유 해제/만료 시 상태가 변경됩니다. 명시적인 "좌석 초기화" API는 존재하지 않습니다.

*   **좌석 상태 조회:** `GET /api/schedules/{scheduleId}/seat-status` (현재 점유 또는 예약된 좌석만 반환)
*   **좌석 점유:** `POST /api/schedules/{scheduleId}/seats/hold` (최대 4석, 10분 점유)
*   **좌석 점유 해제:** `DELETE /api/schedules/{scheduleId}/seats/hold`
*   **좌석 예약 확정:** `POST /api/schedules/{scheduleId}/seats/reserve`

---

### 7단계: 공연 노출

등록된 공연을 사용자에게 공개합니다.

```http
PATCH /api/admin/performances/{performanceId}
Content-Type: application/json
{
  "visible": true
}
```

---

## FE 협의가 필요한 부분

### 1. 좌석 배치도 렌더링 방식 및 좌석 데이터 연동

현재 백엔드는 `Venue` 엔티티의 `seatingChart` 필드에 JSON 문자열 형태로 좌석 배치 정보를 저장하고, `ScheduleSeatStatus` 엔티티를 통해 회차별 개별 좌석의 상태를 관리합니다.

*   `VenueController.getSeatingChart(venueId)`를 통해 공연장의 좌석 배치 JSON 문자열을 조회합니다. 이 JSON 안에 `positionX/Y` 정보가 포함될 수 있습니다.
*   `SeatController.getSeatStatus(scheduleId)`를 통해 특정 회차의 `PENDING` 또는 `RESERVED` 상태 좌석 목록을 조회합니다.
*   프론트엔드에서는 이 두 정보를 조합하여 배치도를 구성하고 좌석 상태를 표시해야 합니다. (SVG 동적 생성 방식 권장)

### 2. 좌석 배치도 등록/수정 UI (관리자용)

관리자가 JSON 형태의 좌석 배치도를 어떻게 편집하고 백엔드로 전송할 것인지에 대한 UI/UX 협의가 필요합니다. `positionX/Y` 좌표를 직접 입력하는 방식은 비효율적이므로, 드래그 앤 드롭 방식의 위지윅(WYSIWYG) 에디터 구현 또는 CSV/Excel 업로드, 템플릿 생성 후 수정 방식 등이 논의될 수 있습니다.

### 3. 실시간 좌석 업데이트

다른 사용자가 좌석을 선택하거나 해제할 때 실시간으로 좌석 상태가 반영되어야 합니다.
현재 `GET /api/schedules/{scheduleId}/seat-status` API를 **주기적으로 폴링(polling)**하는 방식으로 구현을 고려하고 있습니다. SSE (Server-Sent Events)를 이용한 실시간 업데이트는 현재 **미구현** 상태입니다.

### 4. 미구현 기능

*   **이미지 업로드 (MinIO)**: 공연 상세 이미지, 포스터 등 이미지를 MinIO를 통해 업로드하고 관리하는 기능은 아직 구현되지 않았습니다.
*   **지도 API 연동**: 공연장 위치를 지도에 표시하는 기능 (Kakao/Naver/Google Maps)은 아직 구현되지 않았습니다.

---
