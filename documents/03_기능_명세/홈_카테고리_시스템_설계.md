# 홈 카테고리 시스템 설계서

## 개정이력

| 버전 | 일자 | 작성자 | 내용 |
|------|------|--------|------|
| 1.0 | 2025-01-25 | Claude | 최초 작성 |

---

## 1. 개요

### 1.1 목적
홈 화면 배너에 공연을 섹션별로 분류하여 노출하기 위한 카테고리 시스템 설계

### 1.2 요구사항
- 하나의 공연이 여러 카테고리에 동시 노출 가능
- 카테고리는 enum으로 고정 관리
- 지역 카테고리는 공연장 주소 기반 자동 매핑
- 그 외 카테고리는 관리자가 수동 지정
- 섹션/태그/공연 순서 관리 필요

---

## 2. 카테고리 구조

### 2.1 대분류 (HomeSection)

| 순서 | 코드 | 화면 표시명 |
|------|------|-------------|
| 1 | POPULAR_TICKET | 인기티켓 |
| 2 | DATE_COURSE | 데이트코스 |
| 3 | RECOMMENDED | 이런 티켓은 어때요? |
| 4 | REGION | 어디로 떠나볼까요? |

### 2.2 하위 태그 (HomeSectionTag)

#### 인기티켓 (POPULAR_TICKET)
| 순서 | 코드 | 화면 표시명 |
|------|------|-------------|
| 1 | WEEKLY_OPEN | 금주오픈티켓 |
| 2 | MUSICAL | 뮤지컬 |
| 3 | CONCERT | 콘서트 |
| 4 | THEATER | 연극 |
| 5 | EXHIBITION | 전시/행사 |

#### 데이트코스 (DATE_COURSE)
| 순서 | 코드 | 화면 표시명 |
|------|------|-------------|
| 1 | DATE_MUSICAL | 뮤지컬 |
| 2 | DATE_THEATER | 연극 |
| 3 | DATE_CLASSIC | 클래식 |
| 4 | DATE_EXHIBITION | 전시 |

#### 이런 티켓은 어때요? (RECOMMENDED)
| 순서 | 코드 | 화면 표시명 |
|------|------|-------------|
| 1 | LIMITED_SALE | 한정특가 |
| 2 | WITH_KIDS | 아이와 함께 |
| 3 | DAEHAKRO | 대학로공연 |

#### 어디로 떠나볼까요? (REGION) - 자동 매핑
| 순서 | 코드 | 화면 표시명 | 매핑 키워드 |
|------|------|-------------|-------------|
| 1 | REGION_SEOUL | 서울 | 서울 |
| 2 | REGION_GYEONGGI | 경기 | 경기, 수원, 성남, 고양, 용인, 안양, 부천 |
| 3 | REGION_BUSAN | 부산 | 부산 |
| 4 | REGION_DAEGU | 대구 | 대구 |
| 5 | REGION_DAEJEON | 대전 | 대전 |
| 6 | REGION_NATIONWIDE | 전국 | (기본값/투어공연) |

---

## 3. 도메인 모델

### 3.1 Enum 정의

```kotlin
// 대분류 섹션
enum class HomeSection(
    val displayName: String,
    val displayOrder: Int
) {
    POPULAR_TICKET("인기티켓", 1),
    DATE_COURSE("데이트코스", 2),
    RECOMMENDED("이런 티켓은 어때요?", 3),
    REGION("어디로 떠나볼까요?", 4)
}
```

```kotlin
// 하위 태그
enum class HomeSectionTag(
    val section: HomeSection,
    val displayName: String,
    val displayOrder: Int
) {
    // 인기티켓
    WEEKLY_OPEN(HomeSection.POPULAR_TICKET, "금주오픈티켓", 1),
    MUSICAL(HomeSection.POPULAR_TICKET, "뮤지컬", 2),
    CONCERT(HomeSection.POPULAR_TICKET, "콘서트", 3),
    THEATER(HomeSection.POPULAR_TICKET, "연극", 4),
    EXHIBITION(HomeSection.POPULAR_TICKET, "전시/행사", 5),

    // 데이트코스
    DATE_MUSICAL(HomeSection.DATE_COURSE, "뮤지컬", 1),
    DATE_THEATER(HomeSection.DATE_COURSE, "연극", 2),
    DATE_CLASSIC(HomeSection.DATE_COURSE, "클래식", 3),
    DATE_EXHIBITION(HomeSection.DATE_COURSE, "전시", 4),

    // 이런 티켓은 어때요?
    LIMITED_SALE(HomeSection.RECOMMENDED, "한정특가", 1),
    WITH_KIDS(HomeSection.RECOMMENDED, "아이와 함께", 2),
    DAEHAKRO(HomeSection.RECOMMENDED, "대학로공연", 3),

    // 어디로 떠나볼까요? (자동매핑)
    REGION_SEOUL(HomeSection.REGION, "서울", 1),
    REGION_GYEONGGI(HomeSection.REGION, "경기", 2),
    REGION_BUSAN(HomeSection.REGION, "부산", 3),
    REGION_DAEGU(HomeSection.REGION, "대구", 4),
    REGION_DAEJEON(HomeSection.REGION, "대전", 5),
    REGION_NATIONWIDE(HomeSection.REGION, "전국", 6);

    companion object {
        fun getBySection(section: HomeSection): List<HomeSectionTag> =
            entries.filter { it.section == section }
                .sortedBy { it.displayOrder }
    }
}
```

### 3.2 엔티티 정의

```kotlin
@Entity
@Table(
    name = "performance_home_tags",
    uniqueConstraints = [
        UniqueConstraint(columnNames = ["performance_id", "tag"])
    ]
)
class PerformanceHomeTag private constructor(
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "performance_id", nullable = false)
    val performance: Performance,

    @Enumerated(EnumType.STRING)
    @Column(name = "tag", nullable = false, length = 50)
    val tag: HomeSectionTag,

    @Column(name = "display_order", nullable = false)
    var displayOrder: Int,

    @Column(name = "is_auto_tagged", nullable = false)
    val isAutoTagged: Boolean = false
) : BaseEntity() {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0L

    fun updateDisplayOrder(newOrder: Int) {
        this.displayOrder = newOrder
    }

    companion object {
        fun create(
            performance: Performance,
            tag: HomeSectionTag,
            displayOrder: Int,
            isAutoTagged: Boolean = false
        ): PerformanceHomeTag {
            return PerformanceHomeTag(
                performance = performance,
                tag = tag,
                displayOrder = displayOrder,
                isAutoTagged = isAutoTagged
            )
        }
    }
}
```

---

## 4. 지역 자동 매핑

### 4.1 매핑 로직

```kotlin
object RegionMapper {
    private val regionKeywords: Map<HomeSectionTag, List<String>> = mapOf(
        HomeSectionTag.REGION_SEOUL to listOf("서울"),
        HomeSectionTag.REGION_GYEONGGI to listOf("경기", "수원", "성남", "고양", "용인", "안양", "부천", "의정부", "남양주"),
        HomeSectionTag.REGION_BUSAN to listOf("부산"),
        HomeSectionTag.REGION_DAEGU to listOf("대구"),
        HomeSectionTag.REGION_DAEJEON to listOf("대전")
    )

    fun mapFromAddress(address: String?): HomeSectionTag {
        if (address.isNullOrBlank()) {
            return HomeSectionTag.REGION_NATIONWIDE
        }

        return regionKeywords.entries
            .find { (_, keywords) -> keywords.any { address.contains(it) } }
            ?.key
            ?: HomeSectionTag.REGION_NATIONWIDE
    }
}
```

### 4.2 자동 태깅 시점
- 공연 생성 시 venue가 지정되면 자동 태깅
- 공연의 venue 변경 시 기존 자동 태그 삭제 후 재생성
- 수동 태깅과 자동 태깅은 `isAutoTagged` 필드로 구분

---

## 5. API 설계

### 5.1 사용자용 API (홈 화면)

#### 홈 섹션 전체 조회
```
GET /api/home/sections
```

**Response:**
```json
{
  "sections": [
    {
      "section": "POPULAR_TICKET",
      "displayName": "인기티켓",
      "displayOrder": 1,
      "tags": [
        {
          "tag": "WEEKLY_OPEN",
          "displayName": "금주오픈티켓",
          "displayOrder": 1,
          "performances": [
            {
              "id": 1,
              "title": "뮤지컬 위키드",
              "mainImageUrl": "https://...",
              "startDate": "2025-02-01",
              "endDate": "2025-03-31",
              "venueName": "블루스퀘어"
            }
          ]
        }
      ]
    }
  ]
}
```

#### 특정 태그의 공연 목록 조회
```
GET /api/home/tags/{tag}/performances
```

### 5.2 관리자용 API

#### 공연에 태그 추가
```
POST /api/admin/performances/{performanceId}/home-tags
```
**Request:**
```json
{
  "tag": "MUSICAL",
  "displayOrder": 1
}
```

#### 공연의 태그 목록 조회
```
GET /api/admin/performances/{performanceId}/home-tags
```

#### 태그 삭제
```
DELETE /api/admin/performances/{performanceId}/home-tags/{tag}
```

#### 태그 내 공연 순서 변경
```
PATCH /api/admin/home-tags/{tag}/performances/order
```
**Request:**
```json
{
  "performanceOrders": [
    { "performanceId": 1, "displayOrder": 1 },
    { "performanceId": 2, "displayOrder": 2 }
  ]
}
```

---

## 6. 테이블 설계

### 6.1 DDL

```sql
CREATE TABLE performance_home_tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    performance_id BIGINT NOT NULL,
    tag VARCHAR(50) NOT NULL,
    display_order INT NOT NULL DEFAULT 0,
    is_auto_tagged BOOLEAN NOT NULL DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_performance_home_tags_performance
        FOREIGN KEY (performance_id) REFERENCES performances(id) ON DELETE CASCADE,
    CONSTRAINT uk_performance_home_tags_performance_tag
        UNIQUE (performance_id, tag),
    INDEX idx_performance_home_tags_tag (tag),
    INDEX idx_performance_home_tags_tag_order (tag, display_order)
);
```

---

## 7. 패키지 구조

```
src/main/kotlin/com/github/copyinaction/
└── home/
    ├── domain/
    │   ├── HomeSection.kt
    │   ├── HomeSectionTag.kt
    │   ├── PerformanceHomeTag.kt
    │   └── RegionMapper.kt
    ├── repository/
    │   └── PerformanceHomeTagRepository.kt
    ├── service/
    │   ├── HomeService.kt
    │   └── PerformanceHomeTagService.kt
    ├── dto/
    │   ├── HomeSectionResponse.kt
    │   └── PerformanceHomeTagDto.kt
    └── controller/
        ├── HomeController.kt
        └── AdminHomeTagController.kt
```

---

## 8. 구현 범위

### Phase 1 (필수)
- [ ] Enum 정의 (HomeSection, HomeSectionTag)
- [ ] PerformanceHomeTag 엔티티
- [ ] Repository
- [ ] 관리자 API (태그 CRUD)
- [ ] 사용자 API (홈 섹션 조회)

### Phase 2 (후속)
- [ ] 지역 자동 매핑 로직
- [ ] 공연 생성/수정 시 자동 태깅 이벤트 처리
