# 결제 데이터 수집 시스템 설계

## 개정이력
| 버전 | 일자 | 작성자 | 내용 |
|------|------|--------|------|
| 1.0 | 2025-01-05 | Claude | 최초 작성 |
| 1.1 | 2025-01-05 | Claude | completeManually() 메서드 추가 (PG 연동 전 수동 완료 지원) |

---

## 1. 개요

### 1.1 목적
예매 시스템에서 결제 관련 데이터를 체계적으로 수집하여 매출 분석, 할인 효과 측정, 결제 행동 분석 등 비즈니스 인사이트를 도출하기 위한 데이터 모델 설계

### 1.2 현재 상태
- **Booking** 도메인에서 `totalPrice`만 관리
- 독립적인 Payment, Discount, Coupon 도메인 부재
- `Performance.discountInfo` 필드에 텍스트로만 할인 정보 관리

### 1.3 목표
- 결제 전체 라이프사이클 추적 (요청 → 완료 → 취소/환불)
- 할인/쿠폰 적용 내역 구조화
- 분석용 집계 데이터 수집

---

## 2. 도메인 설계

### 2.1 Payment (결제)

#### 2.1.1 엔티티 구조

```kotlin
@Entity
@Table(name = "payments")
class Payment(
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    val id: UUID = UUID.randomUUID(),

    // 예매 연결
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "booking_id", nullable = false)
    val booking: Booking,

    @Column(nullable = false)
    val userId: Long,

    @Column(nullable = false, unique = true)
    val paymentNumber: String,  // PYM-yyyyMMdd-xxxxxx

    // 결제 수단
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    var paymentMethod: PaymentMethod,

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    var paymentStatus: PaymentStatus = PaymentStatus.PENDING,

    // 금액 정보
    @Column(nullable = false)
    val originalPrice: Int,      // 원가 (할인 전 총액)

    @Column(nullable = false)
    var discountAmount: Int = 0, // 총 할인금액

    @Column(nullable = false)
    val bookingFee: Int = 0,     // 예매 수수료

    @Column(nullable = false)
    var finalPrice: Int,         // 최종 결제금액

    // PG 정보
    @Column(length = 50)
    var pgProvider: String? = null,       // 토스/이니시스 등

    @Column(length = 100)
    var pgTransactionId: String? = null,  // PG 거래 ID

    @Column(length = 50)
    var cardCompany: String? = null,      // 카드사

    @Column(length = 20)
    var cardNumberMasked: String? = null, // 카드번호 (마스킹)

    @Column
    var installmentMonths: Int? = null,   // 할부 개월수

    // 시간 정보
    @Column(nullable = false)
    val requestedAt: LocalDateTime = LocalDateTime.now(),

    @Column
    var completedAt: LocalDateTime? = null,

    @Column
    var cancelledAt: LocalDateTime? = null,

    @Column
    var refundedAt: LocalDateTime? = null,

    // 취소/환불 정보
    @Column(length = 500)
    var cancelReason: String? = null,

    @Column
    var refundAmount: Int? = null,

    // 결제 상세 항목
    @OneToMany(mappedBy = "payment", cascade = [CascadeType.ALL], orphanRemoval = true)
    val paymentItems: MutableList<PaymentItem> = mutableListOf(),

    // 적용된 할인 내역
    @OneToMany(mappedBy = "payment", cascade = [CascadeType.ALL], orphanRemoval = true)
    val discounts: MutableList<PaymentDiscount> = mutableListOf()

) : BaseEntity() {

    companion object {
        fun create(
            booking: Booking,
            userId: Long,
            paymentMethod: PaymentMethod,
            originalPrice: Int,
            bookingFee: Int = 0
        ): Payment {
            val paymentNumber = generatePaymentNumber()
            return Payment(
                booking = booking,
                userId = userId,
                paymentMethod = paymentMethod,
                paymentNumber = paymentNumber,
                originalPrice = originalPrice,
                bookingFee = bookingFee,
                finalPrice = originalPrice + bookingFee
            )
        }

        private fun generatePaymentNumber(): String {
            val date = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"))
            val random = (100000..999999).random()
            return "PYM-$date-$random"
        }
    }

    // 결제 완료 (PG 연동 시)
    fun complete(pgProvider: String, pgTransactionId: String) {
        require(paymentStatus == PaymentStatus.PENDING) { "결제 대기 상태에서만 완료 가능" }
        this.paymentStatus = PaymentStatus.COMPLETED
        this.pgProvider = pgProvider
        this.pgTransactionId = pgTransactionId
        this.completedAt = LocalDateTime.now()
    }

    // 수동 결제 완료 (PG 연동 전 / 관리자 수동 처리)
    fun completeManually(adminId: Long? = null, note: String? = null) {
        require(paymentStatus == PaymentStatus.PENDING) { "결제 대기 상태에서만 완료 가능" }
        this.paymentStatus = PaymentStatus.COMPLETED
        this.pgProvider = "MANUAL"
        this.pgTransactionId = adminId?.let { "ADMIN-$it-${System.currentTimeMillis()}" }
        this.completedAt = LocalDateTime.now()
        // note는 별도 로깅 또는 히스토리 테이블에 기록 권장
    }

    // 결제 실패
    fun fail(reason: String) {
        this.paymentStatus = PaymentStatus.FAILED
        this.cancelReason = reason
    }

    // 결제 취소
    fun cancel(reason: String) {
        require(paymentStatus == PaymentStatus.COMPLETED) { "완료된 결제만 취소 가능" }
        this.paymentStatus = PaymentStatus.CANCELLED
        this.cancelReason = reason
        this.cancelledAt = LocalDateTime.now()
    }

    // 환불 처리
    fun refund(amount: Int, reason: String) {
        require(paymentStatus == PaymentStatus.COMPLETED) { "완료된 결제만 환불 가능" }
        require(amount <= finalPrice) { "환불금액이 결제금액을 초과할 수 없음" }

        this.paymentStatus = if (amount == finalPrice)
            PaymentStatus.REFUNDED else PaymentStatus.PARTIAL_REFUNDED
        this.refundAmount = amount
        this.cancelReason = reason
        this.refundedAt = LocalDateTime.now()
    }

    // 할인 적용
    fun applyDiscount(discount: PaymentDiscount) {
        this.discounts.add(discount)
        this.discountAmount += discount.discountAmount
        this.finalPrice = originalPrice + bookingFee - discountAmount
    }

    // 결제 항목 추가
    fun addPaymentItem(item: PaymentItem) {
        this.paymentItems.add(item)
    }
}
```

#### 2.1.2 Enum 정의

```kotlin
enum class PaymentMethod(val description: String) {
    CREDIT_CARD("신용카드"),
    DEBIT_CARD("체크카드"),
    BANK_TRANSFER("계좌이체"),
    VIRTUAL_ACCOUNT("가상계좌"),
    KAKAO_PAY("카카오페이"),
    NAVER_PAY("네이버페이"),
    TOSS_PAY("토스페이"),
    PAYCO("페이코"),
    POINT("포인트")
}

enum class PaymentStatus(val description: String) {
    PENDING("결제대기"),
    COMPLETED("결제완료"),
    FAILED("결제실패"),
    CANCELLED("결제취소"),
    REFUNDED("환불완료"),
    PARTIAL_REFUNDED("부분환불")
}
```

---

### 2.2 PaymentItem (결제 상세 항목)

```kotlin
@Entity
@Table(name = "payment_items")
class PaymentItem(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "payment_id", nullable = false)
    val payment: Payment,

    // 공연 정보 (스냅샷)
    @Column(nullable = false)
    val performanceId: Long,

    @Column(nullable = false, length = 200)
    val performanceTitle: String,

    @Column(nullable = false)
    val scheduleId: Long,

    @Column(nullable = false)
    val showDateTime: LocalDateTime,

    // 좌석 정보
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    val seatGrade: SeatGrade,

    @Column(nullable = false, length = 50)
    val section: String,

    @Column(nullable = false)
    val rowNum: Int,

    @Column(nullable = false)
    val colNum: Int,

    @Column(nullable = false, length = 50)
    val seatLabel: String,  // "A구역 3열 15번"

    // 가격 정보
    @Column(nullable = false)
    val unitPrice: Int,           // 좌석 단가

    @Column(nullable = false)
    var discountAmount: Int = 0,  // 좌석별 할인금액

    @Column(nullable = false)
    var finalPrice: Int           // 최종 금액

) : BaseEntity() {

    companion object {
        fun from(
            payment: Payment,
            bookingSeat: BookingSeat,
            performance: Performance,
            schedule: PerformanceSchedule
        ): PaymentItem {
            return PaymentItem(
                payment = payment,
                performanceId = performance.id,
                performanceTitle = performance.title,
                scheduleId = schedule.id,
                showDateTime = schedule.showDateTime,
                seatGrade = bookingSeat.grade,
                section = bookingSeat.section,
                rowNum = bookingSeat.row,
                colNum = bookingSeat.col,
                seatLabel = "${bookingSeat.section} ${bookingSeat.row}열 ${bookingSeat.col}번",
                unitPrice = bookingSeat.price,
                finalPrice = bookingSeat.price
            )
        }
    }

    fun applyDiscount(amount: Int) {
        this.discountAmount = amount
        this.finalPrice = unitPrice - amount
    }
}
```

---

### 2.3 PaymentDiscount (결제 할인 적용 내역)

```kotlin
@Entity
@Table(name = "payment_discounts")
class PaymentDiscount(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "payment_id", nullable = false)
    val payment: Payment,

    // 할인 유형
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    val discountType: DiscountType,

    @Column(nullable = false, length = 100)
    val discountName: String,        // "신규회원 10% 할인"

    @Column(nullable = false)
    val discountAmount: Int,         // 할인금액

    @Column
    val discountRate: Int? = null,   // 할인율 (%)

    // 쿠폰 연결 (쿠폰 사용 시)
    @Column
    val couponId: Long? = null,

    @Column(length = 50)
    val couponCode: String? = null,

    @Column(nullable = false)
    val appliedAt: LocalDateTime = LocalDateTime.now()

) : BaseEntity()

enum class DiscountType(val description: String) {
    COUPON("쿠폰"),
    EARLY_BIRD("얼리버드"),
    MEMBER_GRADE("회원등급"),
    CARD_PROMOTION("카드사 프로모션"),
    BULK_DISCOUNT("다량구매"),
    EVENT("이벤트"),
    POINT("포인트 사용")
}
```

---

### 2.4 Coupon (쿠폰)

```kotlin
@Entity
@Table(name = "coupons")
class Coupon(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @Column(nullable = false, unique = true, length = 50)
    val code: String,                    // 쿠폰 코드

    @Column(nullable = false, length = 100)
    val name: String,                    // 쿠폰명

    @Column(length = 500)
    val description: String? = null,

    // 할인 정보
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    val discountMethod: DiscountMethod,  // 정액/정률

    @Column(nullable = false)
    val discountValue: Int,              // 할인값 (금액 또는 %)

    @Column
    val maxDiscountAmount: Int? = null,  // 최대 할인금액 (정률 시)

    @Column
    val minOrderAmount: Int? = null,     // 최소 주문금액

    // 사용 조건
    @Column
    val performanceId: Long? = null,     // 특정 공연 한정

    @Column(length = 50)
    val performanceCategory: String? = null, // 카테고리 한정

    @Enumerated(EnumType.STRING)
    val targetSeatGrade: SeatGrade? = null,  // 특정 등급 한정

    // 유효 기간
    @Column(nullable = false)
    val validFrom: LocalDateTime,

    @Column(nullable = false)
    val validUntil: LocalDateTime,

    // 발급 정보
    @Column(nullable = false)
    val totalQuantity: Int,              // 총 발급 수량

    @Column(nullable = false)
    var usedQuantity: Int = 0,           // 사용된 수량

    @Column(nullable = false)
    var isActive: Boolean = true

) : BaseEntity() {

    fun isValid(): Boolean {
        val now = LocalDateTime.now()
        return isActive &&
               now.isAfter(validFrom) &&
               now.isBefore(validUntil) &&
               usedQuantity < totalQuantity
    }

    fun use() {
        require(isValid()) { "유효하지 않은 쿠폰" }
        usedQuantity++
    }

    fun calculateDiscount(orderAmount: Int): Int {
        if (!isValid()) return 0
        if (minOrderAmount != null && orderAmount < minOrderAmount) return 0

        val discount = when (discountMethod) {
            DiscountMethod.FIXED -> discountValue
            DiscountMethod.PERCENTAGE -> (orderAmount * discountValue / 100)
        }

        return maxDiscountAmount?.let { minOf(discount, it) } ?: discount
    }
}

enum class DiscountMethod {
    FIXED,      // 정액 할인
    PERCENTAGE  // 정률 할인
}
```

---

### 2.5 UserCoupon (사용자 쿠폰 보유)

```kotlin
@Entity
@Table(
    name = "user_coupons",
    uniqueConstraints = [UniqueConstraint(columnNames = ["user_id", "coupon_id"])]
)
class UserCoupon(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @Column(nullable = false)
    val userId: Long,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "coupon_id", nullable = false)
    val coupon: Coupon,

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    var status: UserCouponStatus = UserCouponStatus.AVAILABLE,

    @Column(nullable = false)
    val issuedAt: LocalDateTime = LocalDateTime.now(),

    @Column
    var usedAt: LocalDateTime? = null,

    @Column
    var usedPaymentId: UUID? = null

) : BaseEntity() {

    fun use(paymentId: UUID) {
        require(status == UserCouponStatus.AVAILABLE) { "사용 가능한 쿠폰이 아님" }
        require(coupon.isValid()) { "유효하지 않은 쿠폰" }

        this.status = UserCouponStatus.USED
        this.usedAt = LocalDateTime.now()
        this.usedPaymentId = paymentId
        coupon.use()
    }

    fun restore() {
        require(status == UserCouponStatus.USED) { "사용된 쿠폰만 복구 가능" }
        this.status = UserCouponStatus.AVAILABLE
        this.usedAt = null
        this.usedPaymentId = null
    }
}

enum class UserCouponStatus {
    AVAILABLE,   // 사용 가능
    USED,        // 사용됨
    EXPIRED      // 만료됨
}
```

---

## 3. 분석/집계 테이블 설계

### 3.1 DailySalesStats (일별 매출 집계)

```kotlin
@Entity
@Table(name = "daily_sales_stats")
class DailySalesStats(
    @Id
    @Column(nullable = false)
    val date: LocalDate,

    @Column(nullable = false)
    var totalSales: Long = 0,              // 총 매출

    @Column(nullable = false)
    var totalTransactions: Int = 0,        // 거래 건수

    @Column(nullable = false)
    var totalTickets: Int = 0,             // 판매 티켓 수

    @Column(nullable = false)
    var totalDiscounts: Long = 0,          // 총 할인금액

    @Column(nullable = false)
    var totalRefunds: Long = 0,            // 총 환불금액

    @Column(nullable = false)
    var netSales: Long = 0,                // 순매출 (총매출 - 환불)

    @Column(nullable = false)
    var avgOrderValue: Int = 0,            // 평균 주문금액

    @Column(nullable = false)
    var avgTicketPrice: Int = 0,           // 평균 티켓 단가

    @Column(nullable = false)
    var cancelledTransactions: Int = 0,    // 취소 건수

    @Column(nullable = false)
    var failedTransactions: Int = 0,       // 실패 건수

    @Column(nullable = false)
    val updatedAt: LocalDateTime = LocalDateTime.now()
)
```

### 3.2 PerformanceSalesStats (공연별 매출 집계)

```kotlin
@Entity
@Table(name = "performance_sales_stats")
class PerformanceSalesStats(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @Column(nullable = false)
    val performanceId: Long,

    @Column(nullable = false)
    val date: LocalDate,

    // 매출 정보
    @Column(nullable = false)
    var totalRevenue: Long = 0,

    @Column(nullable = false)
    var ticketsSold: Int = 0,

    @Column(nullable = false)
    var totalSeats: Int = 0,

    // 점유율 = ticketsSold / totalSeats * 100
    @Column(nullable = false)
    var occupancyRate: Double = 0.0,

    @Column(nullable = false)
    var avgTicketPrice: Int = 0,

    // 등급별 매출 (JSON)
    @Column(columnDefinition = "TEXT")
    var revenueByGradeJson: String? = null,

    // 할인 사용률
    @Column(nullable = false)
    var discountUsageRate: Double = 0.0,

    @Column(nullable = false)
    var totalDiscountAmount: Long = 0,

    @Column(nullable = false)
    val updatedAt: LocalDateTime = LocalDateTime.now()
)
```

### 3.3 PaymentMethodStats (결제수단별 통계)

```kotlin
@Entity
@Table(name = "payment_method_stats")
class PaymentMethodStats(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    val paymentMethod: PaymentMethod,

    @Column(nullable = false)
    val date: LocalDate,

    @Column(nullable = false)
    var transactionCount: Int = 0,

    @Column(nullable = false)
    var totalAmount: Long = 0,

    @Column(nullable = false)
    var avgAmount: Int = 0,

    @Column(nullable = false)
    var failedCount: Int = 0,

    // 실패율 = failedCount / (transactionCount + failedCount) * 100
    @Column(nullable = false)
    var failureRate: Double = 0.0,

    @Column(nullable = false)
    val updatedAt: LocalDateTime = LocalDateTime.now()
)
```

### 3.4 DiscountStats (할인 효과 통계)

```kotlin
@Entity
@Table(name = "discount_stats")
class DiscountStats(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    val discountType: DiscountType,

    @Column(nullable = false)
    val date: LocalDate,

    @Column(nullable = false)
    var usageCount: Int = 0,              // 사용 횟수

    @Column(nullable = false)
    var totalDiscountAmount: Long = 0,    // 총 할인금액

    @Column(nullable = false)
    var avgDiscountAmount: Int = 0,       // 평균 할인금액

    @Column(nullable = false)
    var conversionCount: Int = 0,         // 결제 완료 건수

    // 전환율 = conversionCount / usageCount * 100
    @Column(nullable = false)
    var conversionRate: Double = 0.0,

    @Column(nullable = false)
    val updatedAt: LocalDateTime = LocalDateTime.now()
)
```

---

## 4. ERD (Entity Relationship Diagram)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Booking                                    │
│  (기존 예매)                                                            │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │ 1:1
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              Payment                                     │
│  ├─ id (UUID, PK)                                                       │
│  ├─ booking_id (FK)                                                     │
│  ├─ payment_number (UNIQUE)                                             │
│  ├─ payment_method (ENUM)                                               │
│  ├─ payment_status (ENUM)                                               │
│  ├─ original_price, discount_amount, booking_fee, final_price           │
│  ├─ pg_provider, pg_transaction_id, card_company, card_number_masked    │
│  └─ requested_at, completed_at, cancelled_at, refunded_at               │
└───────┬─────────────────────────────────────────────┬───────────────────┘
        │ 1:N                                         │ 1:N
        ▼                                             ▼
┌───────────────────────────┐           ┌─────────────────────────────────┐
│      PaymentItem          │           │       PaymentDiscount           │
│  ├─ id (PK)               │           │  ├─ id (PK)                     │
│  ├─ payment_id (FK)       │           │  ├─ payment_id (FK)             │
│  ├─ performance_id        │           │  ├─ discount_type (ENUM)        │
│  ├─ performance_title     │           │  ├─ discount_name               │
│  ├─ schedule_id           │           │  ├─ discount_amount             │
│  ├─ show_date_time        │           │  ├─ discount_rate               │
│  ├─ seat_grade            │           │  ├─ coupon_id (FK, nullable)    │
│  ├─ section, row, col     │           │  └─ applied_at                  │
│  ├─ seat_label            │           └─────────────────────────────────┘
│  └─ unit_price, final_price│
└───────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                              Coupon                                      │
│  ├─ id (PK)                                                             │
│  ├─ code (UNIQUE)                                                       │
│  ├─ name, description                                                   │
│  ├─ discount_method (FIXED/PERCENTAGE)                                  │
│  ├─ discount_value, max_discount_amount, min_order_amount               │
│  ├─ performance_id (nullable), performance_category (nullable)          │
│  ├─ valid_from, valid_until                                             │
│  └─ total_quantity, used_quantity, is_active                            │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │ 1:N
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            UserCoupon                                    │
│  ├─ id (PK)                                                             │
│  ├─ user_id                                                             │
│  ├─ coupon_id (FK)                                                      │
│  ├─ status (AVAILABLE/USED/EXPIRED)                                     │
│  ├─ issued_at, used_at                                                  │
│  └─ used_payment_id (FK, nullable)                                      │
└─────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                            집계 테이블 (Aggregation Tables)
═══════════════════════════════════════════════════════════════════════════

┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│   DailySalesStats    │  │ PerformanceSalesStats│  │  PaymentMethodStats  │
│  ├─ date (PK)        │  │  ├─ performance_id   │  │  ├─ payment_method   │
│  ├─ total_sales      │  │  ├─ date             │  │  ├─ date             │
│  ├─ total_transactions│  │  ├─ total_revenue   │  │  ├─ transaction_count│
│  ├─ total_tickets    │  │  ├─ tickets_sold     │  │  ├─ total_amount     │
│  ├─ total_discounts  │  │  ├─ occupancy_rate   │  │  ├─ failure_rate     │
│  └─ net_sales        │  │  └─ discount_usage   │  │  └─ ...              │
└──────────────────────┘  └──────────────────────┘  └──────────────────────┘
```

---

## 5. API 설계

### 5.1 결제 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/payments` | 결제 요청 생성 |
| POST | `/api/payments/{id}/complete` | 결제 완료 처리 |
| POST | `/api/payments/{id}/cancel` | 결제 취소 |
| POST | `/api/payments/{id}/refund` | 환불 요청 |
| GET | `/api/payments/{id}` | 결제 상세 조회 |
| GET | `/api/payments/booking/{bookingId}` | 예매별 결제 조회 |
| GET | `/api/users/me/payments` | 내 결제 내역 |

### 5.2 쿠폰 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/admin/coupons` | 쿠폰 생성 (관리자) |
| GET | `/api/admin/coupons` | 쿠폰 목록 (관리자) |
| POST | `/api/coupons/{code}/issue` | 쿠폰 발급 |
| GET | `/api/users/me/coupons` | 내 쿠폰 목록 |
| POST | `/api/coupons/validate` | 쿠폰 유효성 검증 |
| POST | `/api/coupons/{id}/apply` | 쿠폰 적용 |

### 5.3 통계 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/admin/stats/daily` | 일별 매출 통계 |
| GET | `/api/admin/stats/performance/{id}` | 공연별 매출 통계 |
| GET | `/api/admin/stats/payment-methods` | 결제수단별 통계 |
| GET | `/api/admin/stats/discounts` | 할인 효과 통계 |

---

## 6. 이벤트 설계

### 6.1 도메인 이벤트

```kotlin
// 결제 요청됨
data class PaymentRequestedEvent(
    val paymentId: UUID,
    val bookingId: UUID,
    val userId: Long,
    val amount: Int,
    val paymentMethod: PaymentMethod
)

// 결제 완료됨
data class PaymentCompletedEvent(
    val paymentId: UUID,
    val bookingId: UUID,
    val userId: Long,
    val finalPrice: Int,
    val discountAmount: Int,
    val completedAt: LocalDateTime
)

// 결제 취소됨
data class PaymentCancelledEvent(
    val paymentId: UUID,
    val bookingId: UUID,
    val reason: String
)

// 환불 처리됨
data class PaymentRefundedEvent(
    val paymentId: UUID,
    val refundAmount: Int,
    val reason: String
)

// 쿠폰 사용됨
data class CouponUsedEvent(
    val couponId: Long,
    val userId: Long,
    val paymentId: UUID,
    val discountAmount: Int
)
```

### 6.2 이벤트 핸들러

```kotlin
@Component
class PaymentEventHandler(
    private val dailySalesStatsService: DailySalesStatsService,
    private val performanceSalesStatsService: PerformanceSalesStatsService
) {
    @TransactionalEventListener
    fun handle(event: PaymentCompletedEvent) {
        // 일별 통계 업데이트
        dailySalesStatsService.incrementSales(
            date = event.completedAt.toLocalDate(),
            amount = event.finalPrice,
            ticketCount = getTicketCount(event.paymentId)
        )

        // 공연별 통계 업데이트
        performanceSalesStatsService.updateStats(event)
    }
}
```

---

## 7. 인덱스 설계

```sql
-- Payment 테이블
CREATE INDEX idx_payment_booking_id ON payments(booking_id);
CREATE INDEX idx_payment_user_id ON payments(user_id);
CREATE INDEX idx_payment_status ON payments(payment_status);
CREATE INDEX idx_payment_requested_at ON payments(requested_at);
CREATE INDEX idx_payment_completed_at ON payments(completed_at);

-- PaymentItem 테이블
CREATE INDEX idx_payment_item_payment_id ON payment_items(payment_id);
CREATE INDEX idx_payment_item_performance_id ON payment_items(performance_id);

-- PaymentDiscount 테이블
CREATE INDEX idx_payment_discount_payment_id ON payment_discounts(payment_id);
CREATE INDEX idx_payment_discount_type ON payment_discounts(discount_type);
CREATE INDEX idx_payment_discount_coupon_id ON payment_discounts(coupon_id);

-- Coupon 테이블
CREATE INDEX idx_coupon_valid_period ON coupons(valid_from, valid_until);
CREATE INDEX idx_coupon_performance_id ON coupons(performance_id);

-- UserCoupon 테이블
CREATE INDEX idx_user_coupon_user_id ON user_coupons(user_id);
CREATE INDEX idx_user_coupon_status ON user_coupons(status);

-- 집계 테이블
CREATE INDEX idx_daily_stats_date ON daily_sales_stats(date);
CREATE INDEX idx_perf_stats_performance_date ON performance_sales_stats(performance_id, date);
CREATE INDEX idx_payment_method_stats_date ON payment_method_stats(date);
```

---

## 8. 데이터 수집 체크리스트

### 8.1 필수 수집 데이터

| 카테고리 | 데이터 | 테이블 | 용도 |
|---------|--------|--------|------|
| 결제 | 결제금액, 수단, 상태 | Payment | 매출 분석 |
| 결제 | PG사, 카드사, 할부 | Payment | 결제 채널 분석 |
| 결제 | 요청/완료/취소 시간 | Payment | 결제 소요시간 분석 |
| 좌석 | 등급, 구역, 좌석번호 | PaymentItem | 좌석 선호도 분석 |
| 좌석 | 좌석별 가격 | PaymentItem | 등급별 매출 분석 |
| 할인 | 할인유형, 금액, 쿠폰코드 | PaymentDiscount | 프로모션 ROI |
| 쿠폰 | 발급/사용/만료 수량 | Coupon, UserCoupon | 쿠폰 효과 측정 |

### 8.2 분석 지표

| 지표 | 계산식 | 집계 테이블 |
|------|--------|------------|
| 일별 매출 | SUM(finalPrice) | DailySalesStats |
| 평균 주문금액 | 총매출 / 거래건수 | DailySalesStats |
| 공연별 점유율 | 판매좌석 / 총좌석 * 100 | PerformanceSalesStats |
| 할인 사용률 | 할인적용건수 / 총거래건수 | DiscountStats |
| 결제 실패율 | 실패건수 / 총시도건수 | PaymentMethodStats |
| 환불율 | 환불건수 / 완료건수 | DailySalesStats |

---

## 9. 구현 로드맵

### Phase 1: 결제 핵심 (2주)
- [ ] Payment 엔티티 및 Repository 구현
- [ ] PaymentItem 엔티티 구현
- [ ] PaymentService 구현 (생성, 완료, 취소)
- [ ] 결제 API 구현
- [ ] Payment 도메인 이벤트 발행

### Phase 2: 할인/쿠폰 (2주)
- [ ] PaymentDiscount 엔티티 구현
- [ ] Coupon, UserCoupon 엔티티 구현
- [ ] CouponService 구현 (발급, 검증, 적용)
- [ ] 쿠폰 API 구현
- [ ] 할인 적용 로직 Payment에 통합

### Phase 3: 통계/분석 (1주)
- [ ] 집계 테이블 생성 (DailySalesStats 등)
- [ ] 이벤트 핸들러로 집계 테이블 업데이트
- [ ] 통계 API 구현
- [ ] 스케줄러로 일별 집계 배치 처리

### Phase 4: 고도화 (1주)
- [ ] 결제 실패 재시도 로직
- [ ] 환불 프로세스 상세 구현
- [ ] 캐싱 적용 (통계 API)
- [ ] 모니터링 대시보드 연동

---

## 10. 참고 사항

### 10.1 PG 연동 고려사항
- 토스페이먼츠, 이니시스 등 PG사 SDK 연동 필요
- Webhook으로 결제 결과 수신
- 결제 검증 로직 필수 (금액 위변조 방지)

### 10.2 보안 고려사항
- 카드번호는 마스킹 처리 후 저장
- PG 거래 ID로 결제 내역 검증
- 환불 시 권한 검증 필수

### 10.3 확장 고려사항
- 포인트 시스템 연동
- 멤버십 등급별 자동 할인
- A/B 테스트용 할인 그룹 관리
