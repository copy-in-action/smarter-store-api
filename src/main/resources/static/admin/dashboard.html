<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드 - 매출 현황</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.8rem;
        }

        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-filter input {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        .date-filter button {
            padding: 8px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .date-filter button:hover {
            background: #f0f0f0;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
        }

        .card.highlight h3 {
            color: rgba(255,255,255,0.8);
        }

        .card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .card .change {
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .card .change.positive {
            color: #22c55e;
        }

        .card .change.negative {
            color: #ef4444;
        }

        .card.highlight .change.positive,
        .card.highlight .change.negative {
            color: rgba(255,255,255,0.9);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .chart-card h2 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #333;
        }

        /* Tables */
        .table-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .table-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-card h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            font-size: 0.85rem;
        }

        td {
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-CONFIRMED {
            background: #dcfce7;
            color: #166534;
        }

        .status-PENDING {
            background: #fef3c7;
            color: #92400e;
        }

        .status-CANCELLED {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-EXPIRED {
            background: #e5e7eb;
            color: #374151;
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
            background: #fee2e2;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .charts-section,
            .table-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            header .container {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Scrollable table */
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .money {
            font-family: 'Courier New', monospace;
        }

        .text-right {
            text-align: right;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>매출 대시보드</h1>
            <div class="date-filter">
                <input type="date" id="startDate">
                <span style="color: white;">~</span>
                <input type="date" id="endDate">
                <button onclick="loadDashboard()">조회</button>
                <button class="refresh-btn" onclick="loadDashboard()">새로고침</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="error-container"></div>

        <!-- Summary Cards -->
        <div class="summary-cards" id="summary-cards">
            <div class="loading">데이터를 불러오는 중...</div>
        </div>

        <!-- Charts -->
        <div class="charts-section">
            <div class="chart-card">
                <h2>일별 매출 추이</h2>
                <canvas id="dailySalesChart"></canvas>
            </div>
            <div class="chart-card">
                <h2>예매 상태 분포</h2>
                <canvas id="bookingStatusChart"></canvas>
            </div>
        </div>

        <!-- Tables -->
        <div class="table-section">
            <div class="table-card">
                <h2>공연별 매출 현황</h2>
                <div class="table-wrapper">
                    <table id="performance-table">
                        <thead>
                            <tr>
                                <th>공연명</th>
                                <th class="text-right">매출</th>
                                <th class="text-right">예매</th>
                                <th class="text-right">판매율</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="loading">데이터를 불러오는 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <h2>최근 예매 내역</h2>
                <div class="table-wrapper">
                    <table id="bookings-table">
                        <thead>
                            <tr>
                                <th>예매번호</th>
                                <th>공연명</th>
                                <th>예매자</th>
                                <th class="text-right">금액</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="loading">데이터를 불러오는 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = '/api/admin/dashboard';

        // Chart instances
        let dailySalesChart = null;
        let bookingStatusChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            loadDashboard();
        });

        function initializeDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
            document.getElementById('endDate').value = formatDate(today);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('ko-KR').format(amount) + '원';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        async function fetchAPI(endpoint, params = {}) {
            const url = new URL(API_BASE_URL + endpoint, window.location.origin);
            Object.entries(params).forEach(([key, value]) => {
                if (value !== null && value !== undefined) {
                    url.searchParams.append(key, value);
                }
            });

            const response = await fetch(url, {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('인증이 필요합니다. 관리자 계정으로 로그인해주세요.');
                }
                throw new Error(`API 요청 실패: ${response.status}`);
            }

            return response.json();
        }

        function showError(message) {
            document.getElementById('error-container').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        async function loadDashboard() {
            clearError();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            try {
                await Promise.all([
                    loadSummary(startDate, endDate),
                    loadDailySales(startDate, endDate),
                    loadPerformanceSales(startDate, endDate),
                    loadRecentBookings()
                ]);
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError(error.message);
            }
        }

        async function loadSummary(startDate, endDate) {
            try {
                const data = await fetchAPI('/summary', { startDate, endDate });
                renderSummaryCards(data);
                renderBookingStatusChart(data);
            } catch (error) {
                document.getElementById('summary-cards').innerHTML = `
                    <div class="error">요약 데이터를 불러올 수 없습니다.</div>
                `;
                throw error;
            }
        }

        function renderSummaryCards(data) {
            const comparison = data.comparisonWithPrevious || {};

            const html = `
                <div class="card highlight">
                    <h3>총 매출</h3>
                    <div class="value money">${formatMoney(data.totalRevenue)}</div>
                    ${renderChange(comparison.revenueChangePercent)}
                </div>
                <div class="card">
                    <h3>총 예매 건수</h3>
                    <div class="value">${formatNumber(data.totalBookings)}건</div>
                    ${renderChange(comparison.bookingsChangePercent)}
                </div>
                <div class="card">
                    <h3>확정 예매</h3>
                    <div class="value">${formatNumber(data.confirmedBookings)}건</div>
                </div>
                <div class="card">
                    <h3>취소 예매</h3>
                    <div class="value">${formatNumber(data.cancelledBookings)}건</div>
                </div>
                <div class="card">
                    <h3>판매 티켓 수</h3>
                    <div class="value">${formatNumber(data.totalTicketsSold)}장</div>
                </div>
                <div class="card">
                    <h3>평균 티켓 가격</h3>
                    <div class="value money">${formatMoney(data.averageTicketPrice)}</div>
                </div>
            `;

            document.getElementById('summary-cards').innerHTML = html;
        }

        function renderChange(percent) {
            if (percent === undefined || percent === null) return '';
            const isPositive = percent >= 0;
            const arrow = isPositive ? '↑' : '↓';
            const className = isPositive ? 'positive' : 'negative';
            return `<div class="change ${className}">${arrow} ${Math.abs(percent).toFixed(1)}% 전 기간 대비</div>`;
        }

        function renderBookingStatusChart(data) {
            const ctx = document.getElementById('bookingStatusChart').getContext('2d');

            if (bookingStatusChart) {
                bookingStatusChart.destroy();
            }

            bookingStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['확정', '취소', '만료', '대기'],
                    datasets: [{
                        data: [
                            data.confirmedBookings,
                            data.cancelledBookings,
                            data.expiredBookings,
                            data.totalBookings - data.confirmedBookings - data.cancelledBookings - data.expiredBookings
                        ],
                        backgroundColor: [
                            '#22c55e',
                            '#ef4444',
                            '#9ca3af',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadDailySales(startDate, endDate) {
            try {
                const data = await fetchAPI('/sales/daily', { startDate, endDate });
                renderDailySalesChart(data);
            } catch (error) {
                console.error('Daily sales load error:', error);
            }
        }

        function renderDailySalesChart(data) {
            const ctx = document.getElementById('dailySalesChart').getContext('2d');

            if (dailySalesChart) {
                dailySalesChart.destroy();
            }

            const labels = data.dailyData.map(d => {
                const date = new Date(d.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const revenues = data.dailyData.map(d => d.revenue);
            const bookings = data.dailyData.map(d => d.bookings);

            dailySalesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '매출',
                            data: revenues,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '예매 건수',
                            data: bookings,
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return (value / 10000).toFixed(0) + '만';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return '매출: ' + formatMoney(context.raw);
                                    }
                                    return '예매: ' + context.raw + '건';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadPerformanceSales(startDate, endDate) {
            try {
                const data = await fetchAPI('/performances', { startDate, endDate, size: 10 });
                renderPerformanceTable(data.content || []);
            } catch (error) {
                document.querySelector('#performance-table tbody').innerHTML = `
                    <tr><td colspan="4" class="error">데이터를 불러올 수 없습니다.</td></tr>
                `;
            }
        }

        function renderPerformanceTable(performances) {
            const tbody = document.querySelector('#performance-table tbody');

            if (performances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888;">데이터가 없습니다.</td></tr>';
                return;
            }

            const html = performances.map(p => `
                <tr>
                    <td>
                        <strong>${escapeHtml(p.title)}</strong>
                        <br><small style="color:#888;">${escapeHtml(p.category)}</small>
                    </td>
                    <td class="text-right money">${formatMoney(p.totalRevenue)}</td>
                    <td class="text-right">${formatNumber(p.confirmedBookings)}건</td>
                    <td class="text-right">${p.salesRate.toFixed(1)}%</td>
                </tr>
            `).join('');

            tbody.innerHTML = html;
        }

        async function loadRecentBookings() {
            try {
                const data = await fetchAPI('/bookings/recent', { limit: 15 });
                renderBookingsTable(data.bookings || []);
            } catch (error) {
                document.querySelector('#bookings-table tbody').innerHTML = `
                    <tr><td colspan="5" class="error">데이터를 불러올 수 없습니다.</td></tr>
                `;
            }
        }

        function renderBookingsTable(bookings) {
            const tbody = document.querySelector('#bookings-table tbody');

            if (bookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">데이터가 없습니다.</td></tr>';
                return;
            }

            const html = bookings.map(b => `
                <tr>
                    <td><code>${escapeHtml(b.bookingNumber)}</code></td>
                    <td>${escapeHtml(truncate(b.performanceTitle, 15))}</td>
                    <td>${escapeHtml(b.userName)}</td>
                    <td class="text-right money">${formatMoney(b.totalPrice)}</td>
                    <td><span class="status-badge status-${b.status}">${getStatusText(b.status)}</span></td>
                </tr>
            `).join('');

            tbody.innerHTML = html;
        }

        function getStatusText(status) {
            const statusMap = {
                'CONFIRMED': '확정',
                'PENDING': '대기',
                'CANCELLED': '취소',
                'EXPIRED': '만료'
            };
            return statusMap[status] || status;
        }

        function truncate(str, length) {
            if (str.length <= length) return str;
            return str.substring(0, length) + '...';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
